{"version":3,"sources":["bootstrap-combobox.js","script.js","pdf.pdfmake.js"],"names":[],"mappings":"AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACnaA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AChxCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"built.js","sourcesContent":["/* =============================================================\n * bootstrap-combobox.js v1.1.5\n * =============================================================\n * Copyright 2012 Daniel Farrell\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n * ============================================================ */\n\n!function( $ ) {\n\n \"use strict\";\n\n /* COMBOBOX PUBLIC CLASS DEFINITION\n  * ================================ */\n\n  var Combobox = function ( element, options ) {\n    this.options = $.extend({}, $.fn.combobox.defaults, options);\n    this.$source = $(element);\n    this.$container = this.setup();\n    this.$element = this.$container.find('input[type=text]');\n    this.$target = this.$container.find('input[type=hidden]');\n    this.$button = this.$container.find('.dropdown-toggle');\n    this.$menu = $(this.options.menu).appendTo('body');\n    this.matcher = this.options.matcher || this.matcher;\n    this.sorter = this.options.sorter || this.sorter;\n    this.highlighter = this.options.highlighter || this.highlighter;\n    this.shown = false;\n    this.selected = false;\n    this.refresh();\n    this.transferAttributes();\n    this.listen();\n  };\n\n  Combobox.prototype = {\n\n    constructor: Combobox\n\n  , setup: function () {\n      var combobox = $(this.options.template);\n      this.$source.before(combobox);\n      this.$source.hide();\n      return combobox;\n    }\n\n  , parse: function () {\n      var that = this\n        , map = {}\n        , source = []\n        , selected = false\n        , selectedValue = '';\n      this.$source.find('option').each(function() {\n        var option = $(this);\n        if (option.val() === '') {\n          that.options.placeholder = option.text();\n          return;\n        }\n        map[option.text()] = option.val();\n        source.push(option.text());\n        if (option.prop('selected')) {\n          selected = option.text();\n          selectedValue = option.val();\n        }\n      })\n      this.map = map;\n      if (selected) {\n        this.$element.val(selected);\n        this.$target.val(selectedValue);\n        this.$container.addClass('combobox-selected');\n        this.selected = true;\n      }\n      return source;\n    }\n\n  , transferAttributes: function() {\n    this.options.placeholder = this.$source.attr('data-placeholder') || this.options.placeholder;\n    this.$element.attr('placeholder', this.options.placeholder);\n    this.$target.prop('name', this.$source.prop('name'));\n    this.$target.val(this.$source.val());\n    this.$source.removeAttr('name');  // Remove from source otherwise form will pass parameter twice.\n    this.$element.attr('required', this.$source.attr('required'));\n    this.$element.attr('rel', this.$source.attr('rel'));\n    this.$element.attr('title', this.$source.attr('title'));\n    this.$element.attr('class', this.$source.attr('class'));\n    this.$element.attr('tabindex', this.$source.attr('tabindex'));\n    this.$source.removeAttr('tabindex');\n    this.$source.removeAttr('required');\n  }\n\n  , setSelected: function() {\n    this.selected = true;\n  }\n\n  , select: function () {\n      var val = this.$menu.find('.active').attr('data-value');\n      this.$element.val(this.updater(val));\n      this.$target.val(this.map[val]);\n      this.$source.val(this.map[val]);\n      this.$element.trigger('change');\n      this.$target.trigger('change');\n      this.$source.trigger('change');\n      this.$container.addClass('combobox-selected');\n      this.selected = true;\n      return this.hide();\n    }\n\n  , updater: function (item) {\n      return item;\n    }\n\n  , show: function () {\n      var pos = $.extend({}, this.$element.position(), {\n        height: this.$element[0].offsetHeight\n      });\n\n      this.$menu\n        .insertAfter(this.$element)\n        .css({\n          top: pos.top + pos.height\n        , left: pos.left\n        })\n        .show();\n\n      this.shown = true;\n      return this;\n    }\n\n  , hide: function () {\n      this.$menu.hide();\n      this.shown = false;\n      return this;\n    }\n\n  , lookup: function (event) {\n      this.query = this.$element.val();\n      return this.process(this.source);\n    }\n\n  , process: function (items) {\n      var that = this;\n\n      items = $.grep(items, function (item) {\n        return that.matcher(item);\n      })\n\n      items = this.sorter(items);\n\n      if (!items.length) {\n        return this.shown ? this.hide() : this;\n      }\n\n      return this.render(items.slice(0, this.options.items)).show();\n    }\n\n  , matcher: function (item) {\n      return ~item.toLowerCase().indexOf(this.query.toLowerCase());\n    }\n\n  , sorter: function (items) {\n      var beginswith = []\n        , caseSensitive = []\n        , caseInsensitive = []\n        , item;\n\n      while (item = items.shift()) {\n        if (!item.toLowerCase().indexOf(this.query.toLowerCase())) {beginswith.push(item);}\n        else if (~item.indexOf(this.query)) {caseSensitive.push(item);}\n        else {caseInsensitive.push(item);}\n      }\n\n      return beginswith.concat(caseSensitive, caseInsensitive);\n    }\n\n  , highlighter: function (item) {\n      var query = this.query.replace(/[\\-\\[\\]{}()*+?.,\\\\\\^$|#\\s]/g, '\\\\$&');\n      return item.replace(new RegExp('(' + query + ')', 'ig'), function ($1, match) {\n        return '<strong>' + match + '</strong>';\n      })\n    }\n\n  , render: function (items) {\n      var that = this;\n\n      items = $(items).map(function (i, item) {\n        i = $(that.options.item).attr('data-value', item);\n        i.find('a').html(that.highlighter(item));\n        return i[0];\n      })\n\n      items.first().addClass('active');\n      this.$menu.html(items);\n      return this;\n    }\n\n  , next: function (event) {\n      var active = this.$menu.find('.active').removeClass('active')\n        , next = active.next();\n\n      if (!next.length) {\n        next = $(this.$menu.find('li')[0]);\n      }\n\n      next.addClass('active');\n    }\n\n  , prev: function (event) {\n      var active = this.$menu.find('.active').removeClass('active')\n        , prev = active.prev();\n\n      if (!prev.length) {\n        prev = this.$menu.find('li').last();\n      }\n\n      prev.addClass('active');\n    }\n\n  , toggle: function () {\n    if (this.$container.hasClass('combobox-selected')) {\n      this.clearTarget();\n      this.triggerChange();\n      this.clearElement();\n    } else {\n      if (this.shown) {\n        this.hide();\n      } else {\n        this.clearElement();\n        this.lookup();\n      }\n    }\n\n    this.$element.trigger('change');\n    this.$target.trigger('change');\n    this.$source.trigger('change');    \n  }\n\n  , clearElement: function () {\n    this.$element.val('').focus();\n  }\n\n  , clearTarget: function () {\n    this.$source.val('');\n    this.$target.val('');\n    this.$container.removeClass('combobox-selected');\n    this.selected = false;\n  }\n\n  , triggerChange: function () {\n    this.$source.trigger('change');\n  }\n\n  , refresh: function () {\n    this.source = this.parse();\n    this.options.items = this.source.length;\n  }\n\n  , listen: function () {\n      this.$element\n        .on('focus',    $.proxy(this.focus, this))\n        .on('blur',     $.proxy(this.blur, this))\n        .on('keypress', $.proxy(this.keypress, this))\n        .on('keyup',    $.proxy(this.keyup, this));\n\n      if (this.eventSupported('keydown')) {\n        this.$element.on('keydown', $.proxy(this.keydown, this));\n      }\n\n      this.$menu\n        .on('click', $.proxy(this.click, this))\n        .on('mouseenter', 'li', $.proxy(this.mouseenter, this))\n        .on('mouseleave', 'li', $.proxy(this.mouseleave, this));\n\n      this.$button\n        .on('click', $.proxy(this.toggle, this));\n    }\n\n  , eventSupported: function(eventName) {\n      var isSupported = eventName in this.$element;\n      if (!isSupported) {\n        this.$element.setAttribute(eventName, 'return;');\n        isSupported = typeof this.$element[eventName] === 'function';\n      }\n      return isSupported;\n    }\n\n  , move: function (e) {\n      if (!this.shown) {return;}\n\n      switch(e.keyCode) {\n        case 9: // tab\n        case 13: // enter\n        case 27: // escape\n          e.preventDefault();\n          break;\n\n        case 38: // up arrow\n          e.preventDefault();\n          this.prev();\n          break;\n\n        case 40: // down arrow\n          e.preventDefault();\n          this.next();\n          break;\n      }\n\n      e.stopPropagation();\n    }\n\n  , keydown: function (e) {\n      this.suppressKeyPressRepeat = ~$.inArray(e.keyCode, [40,38,9,13,27]);\n      this.move(e);\n    }\n\n  , keypress: function (e) {\n      if (this.suppressKeyPressRepeat) {return;}\n      this.move(e);\n    }\n\n  , keyup: function (e) {\n      switch(e.keyCode) {\n        case 40: // down arrow\n        case 39: // right arrow\n        case 38: // up arrow\n        case 37: // left arrow\n        case 36: // home\n        case 35: // end\n        case 33: // page up\n        case 34: // page down\n        case 16: // shift\n        case 17: // ctrl\n        case 18: // alt\n        case 20: // cap lock\n          break;\n\n        case 9: // tab\n        case 13: // enter\n          if (!this.shown) {return;}\n          this.select();\n          break;\n\n        case 27: // escape\n          if (!this.shown) {return;}\n          this.hide();\n          break;\n\n        default:\n          this.clearTarget();\n          this.lookup();\n      }\n\n      e.stopPropagation();\n      e.preventDefault();\n  }\n\n  , focus: function (e) {\n      this.focused = true;\n    }\n\n  , blur: function (e) {\n      var that = this;\n      this.focused = false;\n      var val = this.$element.val();\n      if (!this.selected && val !== '' ) {\n        this.$element.val('');\n        this.$source.val('').trigger('change');\n        this.$target.val('').trigger('change');\n      }\n      if (!this.mousedover && this.shown) {setTimeout(function () { that.hide(); }, 200);}\n    }\n\n  , click: function (e) {\n      e.stopPropagation();\n      e.preventDefault();\n      this.select();\n      this.$element.focus();\n    }\n\n  , mouseenter: function (e) {\n      this.mousedover = true;\n      this.$menu.find('.active').removeClass('active');\n      $(e.currentTarget).addClass('active');\n    }\n\n  , mouseleave: function (e) {\n      this.mousedover = false;\n    }\n  };\n\n  /* COMBOBOX PLUGIN DEFINITION\n   * =========================== */\n\n  $.fn.combobox = function ( option ) {\n    return this.each(function () {\n      var $this = $(this)\n        , data = $this.data('combobox')\n        , options = typeof option == 'object' && option;\n      if(!data) {$this.data('combobox', (data = new Combobox(this, options)));}\n      if (typeof option == 'string') {data[option]();}\n    });\n  };\n\n  $.fn.combobox.defaults = {\n  template: '<div class=\"combobox-container\"> <input type=\"hidden\" /> <div class=\"input-group\"> <input type=\"text\" autocomplete=\"off\" /> <span class=\"input-group-addon dropdown-toggle\" data-dropdown=\"dropdown\"> <span class=\"caret\" /> <i class=\"fa fa-times\"></i> </span> </div> </div> '\n  , menu: '<ul class=\"typeahead typeahead-long dropdown-menu\"></ul>'\n  , item: '<li><a href=\"#\"></a></li>'\n  };\n\n  $.fn.combobox.Constructor = Combobox;\n\n}( window.jQuery );\n","// http://stackoverflow.com/questions/9847580/how-to-detect-safari-chrome-ie-firefox-and-opera-browser\nvar isOpera = !!window.opera || navigator.userAgent.indexOf(' OPR/') >= 0;\nvar isFirefox = typeof InstallTrigger !== 'undefined';   // Firefox 1.0+\nvar isSafari = Object.prototype.toString.call(window.HTMLElement).indexOf('Constructor') > 0;\nvar isEdge = navigator.userAgent.indexOf('Edge/') >= 0;\nvar isChrome = !!window.chrome && !isOpera && !isEdge; // Chrome 1+\nvar isChromium = isChrome && navigator.userAgent.indexOf('Chromium') >= 0;\n// https://code.google.com/p/chromium/issues/detail?id=574648\nvar isChrome48 = isChrome && navigator.userAgent.indexOf('Chrome/48') >= 0;\nvar isIE = /*@cc_on!@*/false || !!document.documentMode; // At least IE6\nvar isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);\nvar isAndroid = /Android/i.test(navigator.userAgent);\nvar isIPhone = /iPhone|iPad|iPod/i.test(navigator.userAgent);\n\nvar refreshTimer;\nfunction generatePDF(invoice, javascript, force, cb) {\n  if (!invoice || !javascript) {\n    return;\n  }\n  //console.log('== generatePDF - force: %s', force);\n  if (force) {\n    refreshTimer = null;\n  } else {\n      if (refreshTimer) {\n        clearTimeout(refreshTimer);\n      }\n      refreshTimer = setTimeout(function() {\n        generatePDF(invoice, javascript, true, cb);\n      }, 500);\n      return;\n  }\n\n  invoice = calculateAmounts(invoice);\n\n  if (parseInt(invoice.account.signature_on_pdf)) {\n      invoice = convertSignature(invoice);\n  }\n\n  // convertSignature returns false to wait for the canvas to draw\n  if (! invoice) {\n      return false;\n  }\n\n  var pdfDoc = GetPdfMake(invoice, javascript, cb);\n\n  if (cb) {\n     pdfDoc.getDataUrl(cb);\n  }\n\n  return pdfDoc;\n}\n\nfunction copyObject(orig) {\n  if (!orig) return false;\n  return JSON.parse(JSON.stringify(orig));\n}\n\n/* Handle converting variables in the invoices (ie, MONTH+1) */\nfunction processVariables(str) {\n  if (!str) return '';\n  var variables = ['MONTH','QUARTER','YEAR'];\n  for (var i=0; i<variables.length; i++) {\n    var variable = variables[i];\n        var regexp = new RegExp(':' + variable + '[+-]?[\\\\d]*', 'g');\n        var matches = str.match(regexp);\n        if (!matches) {\n             continue;\n        }\n        for (var j=0; j<matches.length; j++) {\n            var match = matches[j];\n            var offset = 0;\n            if (match.split('+').length > 1) {\n                offset = match.split('+')[1];\n            } else if (match.split('-').length > 1) {\n                offset = parseInt(match.split('-')[1]) * -1;\n            }\n            str = str.replace(match, getDatePart(variable, offset));\n        }\n  }\n\n  return str;\n}\n\nfunction getDatePart(part, offset) {\n    offset = parseInt(offset);\n    if (!offset) {\n        offset = 0;\n    }\n  if (part == 'MONTH') {\n    return getMonth(offset);\n  } else if (part == 'QUARTER') {\n    return getQuarter(offset);\n  } else if (part == 'YEAR') {\n    return getYear(offset);\n  }\n}\n\nfunction getMonth(offset) {\n  var today = new Date();\n  var months = [ \"January\", \"February\", \"March\", \"April\", \"May\", \"June\",\n            \"July\", \"August\", \"September\", \"October\", \"November\", \"December\" ];\n  var month = today.getMonth();\n    month = parseInt(month) + offset;\n    month = month % 12;\n    if (month < 0) {\n      month += 12;\n    }\n    return months[month];\n}\n\nfunction getYear(offset) {\n  var today = new Date();\n  var year = today.getFullYear();\n  return parseInt(year) + offset;\n}\n\nfunction getQuarter(offset) {\n  var today = new Date();\n  var quarter = Math.floor((today.getMonth() + 3) / 3);\n  quarter += offset;\n    quarter = quarter % 4;\n    if (quarter == 0) {\n         quarter = 4;\n    }\n    return 'Q' + quarter;\n}\n\n// https://gist.github.com/beiyuu/2029907\n$.fn.selectRange = function(start, end) {\n    var e = document.getElementById($(this).attr('id')); // I don't know why... but $(this) don't want to work today :-/\n    if (!e) return;\n    else if (e.setSelectionRange) { e.focus(); e.setSelectionRange(start, end); } /* WebKit */\n    else if (e.createTextRange) { var range = e.createTextRange(); range.collapse(true); range.moveEnd('character', end); range.moveStart('character', start); range.select(); } /* IE */\n    else if (e.selectionStart) { e.selectionStart = start; e.selectionEnd = end; }\n};\n\n/* Default class modification */\nif ($.fn.dataTableExt) {\n  $.extend( $.fn.dataTableExt.oStdClasses, {\n    \"sWrapper\": \"dataTables_wrapper form-inline\"\n  } );\n\n\n  /* API method to get paging information */\n  $.fn.dataTableExt.oApi.fnPagingInfo = function ( oSettings )\n  {\n    return {\n      \"iStart\":         oSettings._iDisplayStart,\n      \"iEnd\":           oSettings.fnDisplayEnd(),\n      \"iLength\":        oSettings._iDisplayLength,\n      \"iTotal\":         oSettings.fnRecordsTotal(),\n      \"iFilteredTotal\": oSettings.fnRecordsDisplay(),\n      \"iPage\":          oSettings._iDisplayLength === -1 ?\n        0 : Math.ceil( oSettings._iDisplayStart / oSettings._iDisplayLength ),\n      \"iTotalPages\":    oSettings._iDisplayLength === -1 ?\n        0 : Math.ceil( oSettings.fnRecordsDisplay() / oSettings._iDisplayLength )\n    };\n  };\n\n\n  /* Bootstrap style pagination control */\n  $.extend( $.fn.dataTableExt.oPagination, {\n    \"bootstrap\": {\n      \"fnInit\": function( oSettings, nPaging, fnDraw ) {\n        var oLang = oSettings.oLanguage.oPaginate;\n        var fnClickHandler = function ( e ) {\n          e.preventDefault();\n          if ( oSettings.oApi._fnPageChange(oSettings, e.data.action) ) {\n            fnDraw( oSettings );\n          }\n        };\n\n        $(nPaging).addClass('pagination').append(\n          '<ul class=\"pagination\">'+\n            '<li class=\"prev disabled\"><a href=\"#\">&laquo;</a></li>'+\n            '<li class=\"next disabled\"><a href=\"#\">&raquo;</a></li>'+\n          '</ul>'\n        );\n        var els = $('a', nPaging);\n        $(els[0]).bind( 'click.DT', { action: \"previous\" }, fnClickHandler );\n        $(els[1]).bind( 'click.DT', { action: \"next\" }, fnClickHandler );\n      },\n\n      \"fnUpdate\": function ( oSettings, fnDraw ) {\n        var iListLength = 5;\n        var oPaging = oSettings.oInstance.fnPagingInfo();\n        var an = oSettings.aanFeatures.p;\n        var i, ien, j, sClass, iStart, iEnd, iHalf=Math.floor(iListLength/2);\n\n        if ( oPaging.iTotalPages < iListLength) {\n          iStart = 1;\n          iEnd = oPaging.iTotalPages;\n        }\n        else if ( oPaging.iPage <= iHalf ) {\n          iStart = 1;\n          iEnd = iListLength;\n        } else if ( oPaging.iPage >= (oPaging.iTotalPages-iHalf) ) {\n          iStart = oPaging.iTotalPages - iListLength + 1;\n          iEnd = oPaging.iTotalPages;\n        } else {\n          iStart = oPaging.iPage - iHalf + 1;\n          iEnd = iStart + iListLength - 1;\n        }\n\n        for ( i=0, ien=an.length ; i<ien ; i++ ) {\n          // Remove the middle elements\n          $('li:gt(0)', an[i]).filter(':not(:last)').remove();\n\n          // Add the new list items and their event handlers\n          for ( j=iStart ; j<=iEnd ; j++ ) {\n            sClass = (j==oPaging.iPage+1) ? 'class=\"active\"' : '';\n            $('<li '+sClass+'><a href=\"#\">'+j+'</a></li>')\n              .insertBefore( $('li:last', an[i])[0] )\n              .bind('click', function (e) {\n                e.preventDefault();\n                oSettings._iDisplayStart = (parseInt($('a', this).text(),10)-1) * oPaging.iLength;\n                fnDraw( oSettings );\n              } );\n          }\n\n          // Add / remove disabled classes from the static elements\n          if ( oPaging.iPage === 0 ) {\n            $('li:first', an[i]).addClass('disabled');\n          } else {\n            $('li:first', an[i]).removeClass('disabled');\n          }\n\n          if ( oPaging.iPage === oPaging.iTotalPages-1 || oPaging.iTotalPages === 0 ) {\n            $('li:last', an[i]).addClass('disabled');\n          } else {\n            $('li:last', an[i]).removeClass('disabled');\n          }\n        }\n      }\n    }\n  } );\n}\n\n/*\n * TableTools Bootstrap compatibility\n * Required TableTools 2.1+\n */\nif ( $.fn.DataTable.TableTools ) {\n  // Set the classes that TableTools uses to something suitable for Bootstrap\n  $.extend( true, $.fn.DataTable.TableTools.classes, {\n    \"container\": \"DTTT btn-group\",\n    \"buttons\": {\n      \"normal\": \"btn\",\n      \"disabled\": \"disabled\"\n    },\n    \"collection\": {\n      \"container\": \"DTTT_dropdown dropdown-menu\",\n      \"buttons\": {\n        \"normal\": \"\",\n        \"disabled\": \"disabled\"\n      }\n    },\n    \"print\": {\n      \"info\": \"DTTT_print_info modal\"\n    },\n    \"select\": {\n      \"row\": \"active\"\n    }\n  } );\n\n  // Have the collection use a bootstrap compatible dropdown\n  $.extend( true, $.fn.DataTable.TableTools.DEFAULTS.oTags, {\n    \"collection\": {\n      \"container\": \"ul\",\n      \"button\": \"li\",\n      \"liner\": \"a\"\n    }\n  } );\n}\n\n\nfunction isStorageSupported() {\n  try {\n      return 'localStorage' in window && window['localStorage'] !== null;\n  } catch (e) {\n      return false;\n  }\n}\n\nfunction isValidEmailAddress(emailAddress) {\n    var pattern = new RegExp(/^((([a-z]|\\d|[!#\\$%&'\\*\\+\\-\\/=\\?\\^_`{\\|}~]|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])+(\\.([a-z]|\\d|[!#\\$%&'\\*\\+\\-\\/=\\?\\^_`{\\|}~]|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])+)*)|((\\x22)((((\\x20|\\x09)*(\\x0d\\x0a))?(\\x20|\\x09)+)?(([\\x01-\\x08\\x0b\\x0c\\x0e-\\x1f\\x7f]|\\x21|[\\x23-\\x5b]|[\\x5d-\\x7e]|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])|(\\\\([\\x01-\\x09\\x0b\\x0c\\x0d-\\x7f]|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF]))))*(((\\x20|\\x09)*(\\x0d\\x0a))?(\\x20|\\x09)+)?(\\x22)))@((([a-z]|\\d|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])|(([a-z]|\\d|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])([a-z]|\\d|-|\\.|_|~|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])*([a-z]|\\d|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])))\\.)+(([a-z]|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])|(([a-z]|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])([a-z]|\\d|-|\\.|_|~|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])*([a-z]|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])))\\.?$/i);\n    return pattern.test(emailAddress);\n};\n\nfunction enableHoverClick($combobox, $entityId, url) {\n  /*\n  $combobox.mouseleave(function() {\n    $combobox.css('text-decoration','none');\n  }).on('mouseenter', function(e) {\n    setAsLink($combobox, $combobox.closest('.combobox-container').hasClass('combobox-selected'));\n  }).on('focusout mouseleave', function(e) {\n    setAsLink($combobox, false);\n  }).on('click', function() {\n    var clientId = $entityId.val();\n    if ($(combobox).closest('.combobox-container').hasClass('combobox-selected')) {\n      if (parseInt(clientId) > 0) {\n        window.open(url + '/' + clientId, '_blank');\n      } else {\n        $('#myModal').modal('show');\n      }\n    };\n  });\n  */\n}\n\nfunction setAsLink($input, enable) {\n  if (enable) {\n    $input.css('text-decoration','underline');\n    $input.css('cursor','pointer');\n  } else {\n    $input.css('text-decoration','none');\n    $input.css('cursor','text');\n  }\n}\n\nfunction setComboboxValue($combobox, id, name) {\n  $combobox.find('input').val(id);\n  $combobox.find('input.form-control').val(name);\n  if (id && name) {\n    $combobox.find('select').combobox('setSelected');\n    $combobox.find('.combobox-container').addClass('combobox-selected');\n  } else {\n    $combobox.find('.combobox-container').removeClass('combobox-selected');\n  }\n}\n\n\nvar BASE64_MARKER = ';base64,';\nfunction convertDataURIToBinary(dataURI) {\n  var base64Index = dataURI.indexOf(BASE64_MARKER) + BASE64_MARKER.length;\n  var base64 = dataURI.substring(base64Index);\n  return base64DecToArr(base64);\n}\n\nif (window.ko) {\n  ko.bindingHandlers.dropdown = {\n      init: function (element, valueAccessor, allBindingsAccessor) {\n         var options = allBindingsAccessor().dropdownOptions|| {};\n         var value = ko.utils.unwrapObservable(valueAccessor());\n         var id = (value && value.public_id) ? value.public_id() : (value && value.id) ? value.id() : value ? value : false;\n         if (id) $(element).val(id);\n         //console.log(\"combo-init: %s\", id);\n         $(element).combobox(options);\n\n         /*\n          ko.utils.registerEventHandler(element, \"change\", function () {\n            console.log(\"change: %s\", $(element).val());\n            //var\n            valueAccessor($(element).val());\n              //$(element).combobox('refresh');\n          });\n          */\n      },\n      update: function (element, valueAccessor) {\n        var value = ko.utils.unwrapObservable(valueAccessor());\n        var id = (value && value.public_id) ? value.public_id() : (value && value.id) ? value.id() : value ? value : false;\n          //console.log(\"combo-update: %s\", id);\n        if (id) {\n          $(element).val(id);\n          $(element).combobox('refresh');\n        } else {\n          $(element).combobox('clearTarget');\n          $(element).combobox('clearElement');\n        }\n      }\n  };\n\n  ko.bindingHandlers.combobox = {\n      init: function (element, valueAccessor, allBindingsAccessor) {\n         var options = allBindingsAccessor().dropdownOptions|| {};\n         var value = ko.utils.unwrapObservable(valueAccessor());\n         var id = (value && value.public_id) ? value.public_id() : (value && value.id) ? value.id() : value ? value : false;\n         if (id) $(element).val(id);\n         $(element).combobox(options);\n\n          ko.utils.registerEventHandler(element, \"change\", function () {\n            var value = valueAccessor();\n            value($(element).val());\n          });\n      },\n      update: function (element, valueAccessor) {\n        var value = ko.utils.unwrapObservable(valueAccessor());\n        var id = (value && value.public_id) ? value.public_id() : (value && value.id) ? value.id() : value ? value : false;\n        if (id) {\n          $(element).val(id);\n          $(element).combobox('refresh');\n        } else {\n          $(element).combobox('clearTarget');\n          $(element).combobox('clearElement');\n        }\n      }\n  };\n\n  ko.bindingHandlers.datePicker = {\n      init: function (element, valueAccessor, allBindingsAccessor) {\n         var value = ko.utils.unwrapObservable(valueAccessor());\n         if (value) $(element).datepicker('update', value);\n         $(element).change(function() {\n            var value = valueAccessor();\n            value($(element).val());\n         })\n      },\n      update: function (element, valueAccessor) {\n         var value = ko.utils.unwrapObservable(valueAccessor());\n         if (value) $(element).datepicker('update', value);\n      }\n  };\n\n  ko.bindingHandlers.placeholder = {\n    init: function (element, valueAccessor, allBindingsAccessor) {\n      var underlyingObservable = valueAccessor();\n      ko.applyBindingsToNode(element, { attr: { placeholder: underlyingObservable } } );\n    }\n  };\n\n  ko.bindingHandlers.tooltip = {\n    init: function(element, valueAccessor) {\n        var local = ko.utils.unwrapObservable(valueAccessor()),\n        options = {};\n\n        ko.utils.extend(options, ko.bindingHandlers.tooltip.options);\n        ko.utils.extend(options, local);\n\n        $(element).tooltip(options);\n\n        ko.utils.domNodeDisposal.addDisposeCallback(element, function() {\n            $(element).tooltip(\"destroy\");\n        });\n    },\n    options: {\n        placement: \"bottom\",\n        trigger: \"hover\"\n    }\n  };\n\n  ko.bindingHandlers.typeahead = {\n      init: function (element, valueAccessor, allBindingsAccessor, viewModel, bindingContext) {\n          var $element = $(element);\n          var allBindings = allBindingsAccessor();\n\n          $element.typeahead({\n              highlight: true,\n              minLength: 0,\n          },\n          {\n              name: 'data',\n              display: allBindings.key,\n              limit: 50,\n              source: searchData(allBindings.items, allBindings.key)\n          }).on('typeahead:change', function(element, datum, name) {\n              var value = valueAccessor();\n              value(datum);\n          });\n      },\n\n      update: function (element, valueAccessor) {\n          var value = ko.utils.unwrapObservable(valueAccessor());\n          if (value) {\n              $(element).typeahead('val', value);\n          }\n      }\n  };\n}\n\nfunction comboboxHighlighter(item) {\n    var query = this.query.replace(/[\\-\\[\\]{}()*+?.,\\\\\\^$|#\\s]/g, '\\\\$&');\n    var result = item.replace(new RegExp('<br/>', 'g'), \"\\n\");\n    result = _.escape(result);\n    result = result.replace(new RegExp('(' + query + ')', 'ig'), function ($1, match) {\n        return match ? '<strong>' + match + '</strong>' : query;\n    });\n    return result.replace(new RegExp(\"\\n\", 'g'), '<br/>');\n}\n\n// https://stackoverflow.com/a/326076/497368\nfunction inIframe () {\n    try {\n        return window.self !== window.top;\n    } catch (e) {\n        return true;\n    }\n}\n\nfunction getContactDisplayName(contact)\n{\n    if (contact.first_name || contact.last_name) {\n        return $.trim((contact.first_name || '') + ' ' + (contact.last_name || ''));\n    } else {\n        return contact.email;\n    }\n}\n\nfunction getContactDisplayNameWithEmail(contact)\n{\n    var str = '';\n\n    if (contact.first_name || contact.last_name) {\n        str += $.trim((contact.first_name || '') + ' ' + (contact.last_name || ''));\n    }\n\n    if (contact.email) {\n        if (str) {\n            str += ' - ';\n        }\n\n        str += contact.email;\n    }\n\n    return $.trim(str);\n}\n\nfunction getClientDisplayName(client)\n{\n  var contact = client.contacts ? client.contacts[0] : false;\n  if (client.name) {\n    return client.name;\n  } else if (contact) {\n    return getContactDisplayName(contact);\n  }\n  return '';\n}\n\n\nvar CONSTS = {};\nCONSTS.INVOICE_STATUS_DRAFT = 1;\nCONSTS.INVOICE_STATUS_SENT = 2;\nCONSTS.INVOICE_STATUS_VIEWED = 3;\nCONSTS.INVOICE_STATUS_APPROVED = 4;\nCONSTS.INVOICE_STATUS_PARTIAL = 5;\nCONSTS.INVOICE_STATUS_PAID = 6;\n\n$.fn.datepicker.defaults.autoclose = true;\n$.fn.datepicker.defaults.todayHighlight = true;\n\nfunction formatAddress(city, state, zip, swap) {\n    var str = '';\n    if (swap) {\n        str += zip ? zip + ' ' : '';\n        str += city ? city : '';\n        str += (city && state) ? ', ' : (city ? ' ' : '');\n        str += state;\n    } else {\n        str += city ? city : '';\n        str += (city && state) ? ', ' : (state ? ' ' : '');\n        str += state + ' ' + zip;\n    }\n    return str;\n}\n\nfunction concatStrings() {\n  var concatStr = '';\n  var data = [];\n  for (var i=0; i<arguments.length; i++) {\n    var string = arguments[i];\n    if (string) {\n      data.push(string);\n    }\n  }\n  for (var i=0; i<data.length; i++) {\n    concatStr += data[i];\n    if (i == 0 && data.length > 1) {\n      concatStr += ', ';\n    } else if (i < data.length -1) {\n      concatStr += ' ';\n    }\n  }\n  return data.length ? concatStr : \"\";\n}\n\nfunction calculateAmounts(invoice) {\n  var total = 0;\n  var hasTaxes = false;\n  var taxes = {};\n  invoice.has_custom_item_value1 = false;\n  invoice.has_custom_item_value2 = false;\n\n  var hasStandard = false;\n  var hasTask = false;\n  var hasDiscount = false;\n\n  // sum line item\n  for (var i=0; i<invoice.invoice_items.length; i++) {\n    var item = invoice.invoice_items[i];\n    var lineTotal = roundSignificant(NINJA.parseFloat(item.cost) * NINJA.parseFloat(item.qty));\n    var discount = roundToTwo(NINJA.parseFloat(item.discount));\n    if (discount != 0) {\n        if (parseInt(invoice.is_amount_discount)) {\n            lineTotal -= discount;\n        } else {\n            lineTotal -= roundToTwo(lineTotal * discount / 100);\n        }\n    }\n\n    lineTotal = roundToTwo(lineTotal);\n    if (lineTotal) {\n      total += lineTotal;\n      total = roundToTwo(total);\n    }\n    if (!item.notes && !item.product_key && !item.cost) {\n        continue;\n    }\n    if (item.invoice_item_type_id == 2) {\n        hasTask = true;\n    } else {\n        hasStandard = true;\n    }\n  }\n\n  invoice.hasTasks = hasTask;\n  invoice.hasStandard = hasStandard;\n  invoice.hasSecondTable = hasTask && hasStandard;\n\n  for (var i=0; i<invoice.invoice_items.length; i++) {\n    var item = invoice.invoice_items[i];\n    var taxRate1 = 0;\n    var taxName1 = '';\n    var taxRate2 = 0;\n    var taxName2 = '';\n\n    if (invoice.features.invoice_settings) {\n        if (item.custom_value1) {\n            invoice.has_custom_item_value1 = true;\n        }\n\n        if (item.custom_value2) {\n            invoice.has_custom_item_value2 = true;\n        }\n    }\n\n    if (parseFloat(item.tax_rate1) != 0 || item.tax_name1) {\n      taxRate1 = parseFloat(item.tax_rate1);\n      taxName1 = item.tax_name1;\n    }\n\n    if (parseFloat(item.tax_rate2) != 0 || item.tax_name2) {\n      taxRate2 = parseFloat(item.tax_rate2);\n      taxName2 = item.tax_name2;\n    }\n\n    // calculate line item tax\n    var lineTotal = roundSignificant(NINJA.parseFloat(item.cost) * NINJA.parseFloat(item.qty));\n    var discount = roundToTwo(NINJA.parseFloat(item.discount));\n    if (discount != 0) {\n        hasDiscount = true;\n        if (parseInt(invoice.is_amount_discount)) {\n            lineTotal -= discount;\n        } else {\n            lineTotal -= roundSignificant(lineTotal * discount / 100);\n        }\n    }\n    lineTotal = roundSignificant(lineTotal);\n\n    if (invoice.discount != 0) {\n        var discount = roundToTwo(NINJA.parseFloat(invoice.discount));\n        if (parseInt(invoice.is_amount_discount)) {\n            lineTotal -= roundSignificant((lineTotal/total) * discount);\n        } else {\n            lineTotal -= roundSignificant(lineTotal * discount / 100);\n        }\n    }\n\n    if (! taxRate1) {\n        var taxAmount1 = 0;\n    } else if (invoice.account.inclusive_taxes != '1') {\n        var taxAmount1 = roundToTwo(lineTotal * taxRate1 / 100);\n    } else {\n        var taxAmount1 = roundToTwo(lineTotal - (lineTotal / (1 + (taxRate1 / 100))))\n    }\n    if (taxAmount1 != 0 || taxName1) {\n      hasTaxes = true;\n      var key = taxName1 + taxRate1;\n      if (taxes.hasOwnProperty(key)) {\n        taxes[key].amount += taxAmount1;\n      } else {\n        taxes[key] = {name: taxName1, rate:taxRate1, amount:taxAmount1};\n      }\n    }\n\n    if (! taxRate2) {\n        var taxAmount2 = 0;\n    } else if (invoice.account.inclusive_taxes != '1') {\n        var taxAmount2 = roundToTwo(lineTotal * taxRate2 / 100);\n    } else {\n        var taxAmount2 = roundToTwo(lineTotal - (lineTotal / (1 + (taxRate2 / 100))))\n    }\n    if (taxAmount2 != 0 || taxName2) {\n      hasTaxes = true;\n      var key = taxName2 + taxRate2;\n      if (taxes.hasOwnProperty(key)) {\n        taxes[key].amount += taxAmount2;\n      } else {\n        taxes[key] = {name: taxName2, rate:taxRate2, amount:taxAmount2};\n      }\n    }\n  }\n\n  invoice.has_item_taxes = hasTaxes;\n  invoice.has_item_discounts = hasDiscount;\n  invoice.subtotal_amount = total;\n\n  var discount = 0;\n  if (invoice.discount != 0) {\n    if (parseInt(invoice.is_amount_discount)) {\n      discount = roundToTwo(invoice.discount);\n    } else {\n      discount = roundToTwo(total * roundToTwo(invoice.discount) / 100);\n    }\n    total -= discount;\n  }\n\n  // custom fields with taxes\n  if (NINJA.parseFloat(invoice.custom_value1) && invoice.custom_taxes1 == '1') {\n    total += roundToTwo(invoice.custom_value1);\n  }\n  if (NINJA.parseFloat(invoice.custom_value2) && invoice.custom_taxes2 == '1') {\n    total += roundToTwo(invoice.custom_value2);\n  }\n\n  taxRate1 = 0;\n  taxRate2 = 0;\n  if (parseFloat(invoice.tax_rate1 || 0) != 0) {\n    taxRate1 = parseFloat(invoice.tax_rate1);\n  }\n  if (parseFloat(invoice.tax_rate2 || 0) != 0) {\n    taxRate2 = parseFloat(invoice.tax_rate2);\n  }\n\n  if (invoice.account.inclusive_taxes != '1') {\n      taxAmount1 = roundToTwo(total * taxRate1 / 100);\n      taxAmount2 = roundToTwo(total * taxRate2 / 100);\n      total = total + taxAmount1 + taxAmount2;\n\n      for (var key in taxes) {\n        if (taxes.hasOwnProperty(key)) {\n            total += taxes[key].amount;\n        }\n      }\n  } else {\n     taxAmount1 = roundToTwo(total - (total / (1 + (taxRate1 / 100))))\n     taxAmount2 = roundToTwo(total - (total / (1 + (taxRate2 / 100))))\n  }\n\n  // custom fields w/o with taxes\n  if (NINJA.parseFloat(invoice.custom_value1) && invoice.custom_taxes1 != '1') {\n    total += roundToTwo(invoice.custom_value1);\n  }\n  if (NINJA.parseFloat(invoice.custom_value2) && invoice.custom_taxes2 != '1') {\n    total += roundToTwo(invoice.custom_value2);\n  }\n\n  invoice.total_amount = roundToTwo(roundToTwo(total) - (roundToTwo(invoice.amount) - roundToTwo(invoice.balance)));\n  invoice.discount_amount = discount;\n  invoice.tax_amount1 = taxAmount1;\n  invoice.tax_amount2 = taxAmount2;\n  invoice.item_taxes = taxes;\n\n  if (NINJA.parseFloat(invoice.partial)) {\n    invoice.balance_amount = roundToTwo(invoice.partial);\n  } else {\n    invoice.balance_amount = invoice.total_amount;\n  }\n\n  return invoice;\n}\n\n// http://stackoverflow.com/questions/11941876/correctly-suppressing-warnings-in-datatables\nwindow.alert = (function() {\n    var nativeAlert = window.alert;\n    return function(message) {\n        window.alert = nativeAlert;\n        message && message.indexOf(\"DataTables warning\") === 0 ?\n            console.error(message) :\n            nativeAlert(message);\n    }\n})();\n\n\n// http://stackoverflow.com/questions/1068834/object-comparison-in-javascript\nfunction objectEquals(x, y) {\n    // if both are function\n    if (x instanceof Function) {\n        if (y instanceof Function) {\n            return x.toString() === y.toString();\n        }\n        return false;\n    }\n    if (x === null || x === undefined || y === null || y === undefined) { return x === y; }\n    if (x === y || x.valueOf() === y.valueOf()) { return true; }\n\n    // if one of them is date, they must had equal valueOf\n    if (x instanceof Date) { return false; }\n    if (y instanceof Date) { return false; }\n\n    // if they are not function or strictly equal, they both need to be Objects\n    if (!(x instanceof Object)) { return false; }\n    if (!(y instanceof Object)) { return false; }\n\n    var p = Object.keys(x);\n    return Object.keys(y).every(function (i) { return p.indexOf(i) !== -1; }) ?\n            p.every(function (i) { return objectEquals(x[i], y[i]); }) : false;\n}\n\n\n\n/*\\\n|*|\n|*|  Base64 / binary data / UTF-8 strings utilities\n|*|\n|*|  https://developer.mozilla.org/en-US/docs/Web/JavaScript/Base64_encoding_and_decoding\n|*|\n\\*/\n\n/* Array of bytes to base64 string decoding */\n\nfunction b64ToUint6 (nChr) {\n\n  return nChr > 64 && nChr < 91 ?\n      nChr - 65\n    : nChr > 96 && nChr < 123 ?\n      nChr - 71\n    : nChr > 47 && nChr < 58 ?\n      nChr + 4\n    : nChr === 43 ?\n      62\n    : nChr === 47 ?\n      63\n    :\n      0;\n\n}\n\nfunction base64DecToArr (sBase64, nBlocksSize) {\n\n  var\n    sB64Enc = sBase64.replace(/[^A-Za-z0-9\\+\\/]/g, \"\"), nInLen = sB64Enc.length,\n    nOutLen = nBlocksSize ? Math.ceil((nInLen * 3 + 1 >> 2) / nBlocksSize) * nBlocksSize : nInLen * 3 + 1 >> 2, taBytes = new Uint8Array(nOutLen);\n\n  for (var nMod3, nMod4, nUint24 = 0, nOutIdx = 0, nInIdx = 0; nInIdx < nInLen; nInIdx++) {\n    nMod4 = nInIdx & 3;\n    nUint24 |= b64ToUint6(sB64Enc.charCodeAt(nInIdx)) << 18 - 6 * nMod4;\n    if (nMod4 === 3 || nInLen - nInIdx === 1) {\n      for (nMod3 = 0; nMod3 < 3 && nOutIdx < nOutLen; nMod3++, nOutIdx++) {\n        taBytes[nOutIdx] = nUint24 >>> (16 >>> nMod3 & 24) & 255;\n      }\n      nUint24 = 0;\n\n    }\n  }\n\n  return taBytes;\n}\n\n/* Base64 string to array encoding */\n\nfunction uint6ToB64 (nUint6) {\n\n  return nUint6 < 26 ?\n      nUint6 + 65\n    : nUint6 < 52 ?\n      nUint6 + 71\n    : nUint6 < 62 ?\n      nUint6 - 4\n    : nUint6 === 62 ?\n      43\n    : nUint6 === 63 ?\n      47\n    :\n      65;\n\n}\n\nfunction base64EncArr (aBytes) {\n\n  var nMod3 = 2, sB64Enc = \"\";\n\n  for (var nLen = aBytes.length, nUint24 = 0, nIdx = 0; nIdx < nLen; nIdx++) {\n    nMod3 = nIdx % 3;\n    if (nIdx > 0 && (nIdx * 4 / 3) % 76 === 0) { sB64Enc += \"\\r\\n\"; }\n    nUint24 |= aBytes[nIdx] << (16 >>> nMod3 & 24);\n    if (nMod3 === 2 || aBytes.length - nIdx === 1) {\n      sB64Enc += String.fromCharCode(uint6ToB64(nUint24 >>> 18 & 63), uint6ToB64(nUint24 >>> 12 & 63), uint6ToB64(nUint24 >>> 6 & 63), uint6ToB64(nUint24 & 63));\n      nUint24 = 0;\n    }\n  }\n\n  return sB64Enc.substr(0, sB64Enc.length - 2 + nMod3) + (nMod3 === 2 ? '' : nMod3 === 1 ? '=' : '==');\n\n}\n\n/* UTF-8 array to DOMString and vice versa */\n\nfunction UTF8ArrToStr (aBytes) {\n\n  var sView = \"\";\n\n  for (var nPart, nLen = aBytes.length, nIdx = 0; nIdx < nLen; nIdx++) {\n    nPart = aBytes[nIdx];\n    sView += String.fromCharCode(\n      nPart > 251 && nPart < 254 && nIdx + 5 < nLen ? /* six bytes */\n        /* (nPart - 252 << 32) is not possible in ECMAScript! So...: */\n        (nPart - 252) * 1073741824 + (aBytes[++nIdx] - 128 << 24) + (aBytes[++nIdx] - 128 << 18) + (aBytes[++nIdx] - 128 << 12) + (aBytes[++nIdx] - 128 << 6) + aBytes[++nIdx] - 128\n      : nPart > 247 && nPart < 252 && nIdx + 4 < nLen ? /* five bytes */\n        (nPart - 248 << 24) + (aBytes[++nIdx] - 128 << 18) + (aBytes[++nIdx] - 128 << 12) + (aBytes[++nIdx] - 128 << 6) + aBytes[++nIdx] - 128\n      : nPart > 239 && nPart < 248 && nIdx + 3 < nLen ? /* four bytes */\n        (nPart - 240 << 18) + (aBytes[++nIdx] - 128 << 12) + (aBytes[++nIdx] - 128 << 6) + aBytes[++nIdx] - 128\n      : nPart > 223 && nPart < 240 && nIdx + 2 < nLen ? /* three bytes */\n        (nPart - 224 << 12) + (aBytes[++nIdx] - 128 << 6) + aBytes[++nIdx] - 128\n      : nPart > 191 && nPart < 224 && nIdx + 1 < nLen ? /* two bytes */\n        (nPart - 192 << 6) + aBytes[++nIdx] - 128\n      : /* nPart < 127 ? */ /* one byte */\n        nPart\n    );\n  }\n\n  return sView;\n\n}\n\nfunction strToUTF8Arr (sDOMStr) {\n\n  var aBytes, nChr, nStrLen = sDOMStr.length, nArrLen = 0;\n\n  /* mapping... */\n\n  for (var nMapIdx = 0; nMapIdx < nStrLen; nMapIdx++) {\n    nChr = sDOMStr.charCodeAt(nMapIdx);\n    nArrLen += nChr < 0x80 ? 1 : nChr < 0x800 ? 2 : nChr < 0x10000 ? 3 : nChr < 0x200000 ? 4 : nChr < 0x4000000 ? 5 : 6;\n  }\n\n  aBytes = new Uint8Array(nArrLen);\n\n  /* transcription... */\n\n  for (var nIdx = 0, nChrIdx = 0; nIdx < nArrLen; nChrIdx++) {\n    nChr = sDOMStr.charCodeAt(nChrIdx);\n    if (nChr < 128) {\n      /* one byte */\n      aBytes[nIdx++] = nChr;\n    } else if (nChr < 0x800) {\n      /* two bytes */\n      aBytes[nIdx++] = 192 + (nChr >>> 6);\n      aBytes[nIdx++] = 128 + (nChr & 63);\n    } else if (nChr < 0x10000) {\n      /* three bytes */\n      aBytes[nIdx++] = 224 + (nChr >>> 12);\n      aBytes[nIdx++] = 128 + (nChr >>> 6 & 63);\n      aBytes[nIdx++] = 128 + (nChr & 63);\n    } else if (nChr < 0x200000) {\n      /* four bytes */\n      aBytes[nIdx++] = 240 + (nChr >>> 18);\n      aBytes[nIdx++] = 128 + (nChr >>> 12 & 63);\n      aBytes[nIdx++] = 128 + (nChr >>> 6 & 63);\n      aBytes[nIdx++] = 128 + (nChr & 63);\n    } else if (nChr < 0x4000000) {\n      /* five bytes */\n      aBytes[nIdx++] = 248 + (nChr >>> 24);\n      aBytes[nIdx++] = 128 + (nChr >>> 18 & 63);\n      aBytes[nIdx++] = 128 + (nChr >>> 12 & 63);\n      aBytes[nIdx++] = 128 + (nChr >>> 6 & 63);\n      aBytes[nIdx++] = 128 + (nChr & 63);\n    } else /* if (nChr <= 0x7fffffff) */ {\n      /* six bytes */\n      aBytes[nIdx++] = 252 + /* (nChr >>> 32) is not possible in ECMAScript! So...: */ (nChr / 1073741824);\n      aBytes[nIdx++] = 128 + (nChr >>> 24 & 63);\n      aBytes[nIdx++] = 128 + (nChr >>> 18 & 63);\n      aBytes[nIdx++] = 128 + (nChr >>> 12 & 63);\n      aBytes[nIdx++] = 128 + (nChr >>> 6 & 63);\n      aBytes[nIdx++] = 128 + (nChr & 63);\n    }\n  }\n\n  return aBytes;\n\n}\n\n\n\nfunction hexToR(h) {return parseInt((cutHex(h)).substring(0,2),16)}\nfunction hexToG(h) {return parseInt((cutHex(h)).substring(2,4),16)}\nfunction hexToB(h) {return parseInt((cutHex(h)).substring(4,6),16)}\nfunction cutHex(h) {return (h.charAt(0)==\"#\") ? h.substring(1,7):h}\nfunction setDocHexColor(doc, hex) {\n  var r = hexToR(hex);\n  var g = hexToG(hex);\n  var b = hexToB(hex);\n  return doc.setTextColor(r, g, b);\n}\nfunction setDocHexFill(doc, hex) {\n  var r = hexToR(hex);\n  var g = hexToG(hex);\n  var b = hexToB(hex);\n  return doc.setFillColor(r, g, b);\n}\nfunction setDocHexDraw(doc, hex) {\n  var r = hexToR(hex);\n  var g = hexToG(hex);\n  var b = hexToB(hex);\n  return doc.setDrawColor(r, g, b);\n}\n\nfunction toggleDatePicker(field) {\n  $('#'+field).datepicker('show');\n}\n\nfunction getPrecision(number) {\n  if (roundToPrecision(number, 3) != number) {\n    return 4;\n  } else if (roundToPrecision(number, 2) != number) {\n    return 3;\n  } else {\n    return 2;\n  }\n}\n\nfunction roundSignificant(number, toString) {\n  var precision = getPrecision(number);\n  var val = roundToPrecision(number, precision) || 0;\n  return toString ? val.toFixed(precision) : val;\n}\n\nfunction roundToTwo(number, toString) {\n  var val = roundToPrecision(number, 2) || 0;\n  return toString ? val.toFixed(2) : val;\n}\n\nfunction roundToFour(number, toString) {\n  var val = roundToPrecision(number, 4) || 0;\n  return toString ? val.toFixed(4) : val;\n}\n\n// https://stackoverflow.com/a/18358056/497368\nfunction roundToPrecision(number, precision) {\n  // prevent negative numbers from rounding to 0\n  var isNegative = number < 0;\n  if (isNegative) {\n      number = number * -1;\n  }\n  number = +(Math.round(number + \"e+\"+ precision) + \"e-\" + precision);\n  if (isNegative) {\n      number = number * -1;\n  }\n  return number;\n}\n\nfunction truncate(str, length) {\n  return (str && str.length > length) ? (str.substr(0, length-1) + '...') : str;\n}\n\n// http://stackoverflow.com/questions/280634/endswith-in-javascript\nfunction endsWith(str, suffix) {\n    return str.indexOf(suffix, str.length - suffix.length) !== -1;\n}\n\n// http://codeaid.net/javascript/convert-seconds-to-hours-minutes-and-seconds-%28javascript%29\nfunction secondsToTime(secs)\n{\n    secs = Math.round(secs);\n    var hours = Math.floor(secs / (60 * 60));\n\n    var divisor_for_minutes = secs % (60 * 60);\n    var minutes = Math.floor(divisor_for_minutes / 60);\n\n    var divisor_for_seconds = divisor_for_minutes % 60;\n    var seconds = Math.ceil(divisor_for_seconds);\n\n    var obj = {\n        \"h\": hours,\n        \"m\": minutes,\n        \"s\": seconds\n    };\n    return obj;\n}\n\nfunction twoDigits(value) {\n   if (value < 10) {\n       return '0' + value;\n   }\n   return value;\n}\n\nfunction toSnakeCase(str) {\n    if (!str) return '';\n    return str.replace(/([A-Z])/g, function($1){return \"_\"+$1.toLowerCase();});\n}\n\n// https://coderwall.com/p/iprsng/convert-snake-case-to-camelcase\nfunction snakeToCamel(s){\n    return s.replace(/_([a-z])/g, function (g) { return g[1].toUpperCase(); });\n}\n\nfunction getDescendantProp(obj, desc) {\n    var arr = desc.split(\".\");\n    while(arr.length && (obj = obj[arr.shift()]));\n    return obj;\n}\n\nfunction doubleDollarSign(str) {\n    if (!str) return '';\n    if (!str.replace) return str;\n    return str.replace(/\\$/g, '\\$\\$\\$');\n}\n\nfunction truncate(string, length){\n   if (string.length > length) {\n      return string.substring(0, length) + '...';\n   } else {\n      return string;\n   }\n};\n\n// Show/hide the 'Select' option in the datalists\nfunction actionListHandler() {\n    $('tbody tr .tr-action').closest('tr').mouseover(function() {\n        $(this).closest('tr').find('.tr-action').show();\n        $(this).closest('tr').find('.tr-status').hide();\n    }).mouseout(function() {\n        $dropdown = $(this).closest('tr').find('.tr-action');\n        if (!$dropdown.hasClass('open')) {\n          $dropdown.hide();\n          $(this).closest('tr').find('.tr-status').show();\n        }\n    });\n}\n\nfunction loadImages(selector) {\n    $(selector + ' img').each(function(index, item) {\n        var src = $(item).attr('data-src');\n        $(item).attr('src', src);\n        $(item).attr('data-src', src);\n    });\n}\n\n// http://stackoverflow.com/questions/4810841/how-can-i-pretty-print-json-using-javascript\nfunction prettyJson(json) {\n    if (typeof json != 'string') {\n         json = JSON.stringify(json, undefined, 2);\n    }\n    json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');\n    return json.replace(/(\"(\\\\u[a-zA-Z0-9]{4}|\\\\[^u]|[^\\\\\"])*\"(\\s*:)?|\\b(true|false|null)\\b|-?\\d+(?:\\.\\d*)?(?:[eE][+\\-]?\\d+)?)/g, function (match) {\n        var cls = 'number';\n        if (/^\"/.test(match)) {\n            if (/:$/.test(match)) {\n                cls = 'key';\n            } else {\n                cls = 'string';\n            }\n        } else if (/true|false/.test(match)) {\n            cls = 'boolean';\n        } else if (/null/.test(match)) {\n            cls = 'null';\n        }\n        match = snakeToCamel(match);\n        return '<span class=\"' + cls + '\">' + match + '</span>';\n    });\n}\n\nfunction searchData(data, key, fuzzy, secondKey) {\n    return function findMatches(q, cb) {\n    var matches, substringRegex;\n    if (fuzzy) {\n        var options = {\n          keys: [key],\n        }\n        var fuse = new Fuse(data, options);\n        matches = fuse.search(q);\n    } else {\n        matches = [];\n        substrRegex = new RegExp(escapeRegExp(q), 'i');\n        $.each(data, function(i, obj) {\n          if (substrRegex.test(obj[key])) {\n            matches.push(obj);\n          } else if (secondKey && substrRegex.test(obj[secondKey]))\n            matches.push(obj);\n          });\n    }\n    cb(matches);\n    }\n};\n\nfunction escapeRegExp(str) {\n  return str.replace(/[\\-\\[\\]\\/\\{\\}\\(\\)\\*\\+\\?\\.\\\\\\^\\$\\|]/g, \"\\\\$&\");\n}\n\nfunction firstJSONError(json) {\n    for (var key in json) {\n        if ( ! json.hasOwnProperty(key)) {\n            continue;\n        }\n        var item = json[key];\n        for (var subKey in item) {\n            if ( ! item.hasOwnProperty(subKey)) {\n                continue;\n            }\n            return item[subKey];\n        }\n    }\n    return false;\n}\n\n// http://stackoverflow.com/questions/10073699/pad-a-number-with-leading-zeros-in-javascript\nfunction pad(n, width, z) {\n    z = z || '0';\n    n = n + '';\n    return n.length >= width ? n : new Array(width - n.length + 1).join(z) + n;\n}\n\nfunction brewerColor(number) {\n    var colors = [\n        '#1c9f77',\n        '#d95d02',\n        '#716cb1',\n        '#e62a8b',\n        '#5fa213',\n        '#e6aa04',\n        '#a87821',\n        '#676767',\n    ];\n    var number = (number-1) % colors.length;\n\n    return colors[number];\n}\n\n// https://gist.github.com/sente/1083506\nfunction formatXml(xml) {\n    var formatted = '';\n    var reg = /(>)(<)(\\/*)/g;\n    xml = xml.replace(reg, '$1\\r\\n$2$3');\n    var pad = 0;\n    jQuery.each(xml.split('\\r\\n'), function(index, node) {\n        var indent = 0;\n        if (node.match( /.+<\\/\\w[^>]*>$/ )) {\n            indent = 0;\n        } else if (node.match( /^<\\/\\w/ )) {\n            if (pad != 0) {\n                pad -= 1;\n            }\n        } else if (node.match( /^<\\w[^>]*[^\\/]>.*$/ )) {\n            indent = 1;\n        } else {\n            indent = 0;\n        }\n\n        var padding = '';\n        for (var i = 0; i < pad; i++) {\n            padding += '  ';\n        }\n\n        formatted += padding + node + '\\r\\n';\n        pad += indent;\n    });\n\n    return formatted;\n}\n\nfunction openUrlOnClick(url, event) {\n    if (event.ctrlKey) {\n        window.open(url, '_blank');\n    } else {\n        window.location = url;\n    }\n}\n\n// https://stackoverflow.com/a/11268104/497368\nfunction scorePassword(pass) {\n    var score = 0;\n    if (!pass)\n    return score;\n\n    // award every unique letter until 5 repetitions\n    var letters = new Object();\n    for (var i=0; i<pass.length; i++) {\n        letters[pass[i]] = (letters[pass[i]] || 0) + 1;\n        score += 5.0 / letters[pass[i]];\n    }\n\n    // bonus points for mixing it up\n    var variations = {\n        digits: /\\d/.test(pass),\n        lower: /[a-z]/.test(pass),\n        upper: /[A-Z]/.test(pass),\n        nonWords: /\\W/.test(pass),\n    }\n\n    variationCount = 0;\n    for (var check in variations) {\n        variationCount += (variations[check] == true) ? 1 : 0;\n    }\n    score += (variationCount - 1) * 10;\n\n    return parseInt(score);\n}\n","var NINJA = NINJA || {};\n\nNINJA.TEMPLATES = {\n    CLEAN: \"1\",\n    BOLD:\"2\",\n    MODERN: \"3\",\n    NORMAL:\"4\",\n    BUSINESS:\"5\",\n    CREATIVE:\"6\",\n    ELEGANT:\"7\",\n    HIPSTER:\"8\",\n    PLAYFUL:\"9\",\n    PHOTO:\"10\"\n};\n\nfunction GetPdfMake(invoice, javascript, callback) {\n    var itemsTable = false;\n\n    // check if we need to add a second table for tasks\n    if (invoice.hasTasks) {\n        if (invoice.hasSecondTable) {\n            var json = JSON.parse(javascript);\n            for (var i=0; i<json.content.length; i++) {\n                var item = json.content[i];\n                if (item.table && item.table.body == '$invoiceLineItems') {\n                    itemsTable = JSON.stringify(item);\n                    itemsTable = itemsTable.replace('$invoiceLineItems', '$taskLineItems');\n                    itemsTable = itemsTable.replace('$invoiceLineItemColumns', '$taskLineItemColumns');\n                    break;\n                }\n            }\n            itemsTable = JSON.parse(itemsTable);\n            json.content.splice(i+1, 0, itemsTable);\n            javascript = JSON.stringify(json);\n        // use the single product table for tasks\n        } else {\n            javascript = javascript.replace('$invoiceLineItems', '$taskLineItems');\n            javascript = javascript.replace('$invoiceLineItemColumns', '$taskLineItemColumns');\n        }\n    } else if (invoice.is_statement) {\n        var json = JSON.parse(javascript);\n        for (var i=0; i<json.content.length; i++) {\n            var item = json.content[i];\n            if (item.table && item.table.body == '$invoiceLineItems') {\n                json.content.splice(i, 2);\n                json.content.splice(i, 0, \"$statementDetails\");\n            }\n        }\n        javascript = JSON.stringify(json);\n    }\n\n    javascript = NINJA.decodeJavascript(invoice, javascript);\n\n    function jsonCallBack(key, val) {\n\n        // handle custom functions\n        if (typeof val === 'string') {\n            if (val.indexOf('$firstAndLast') === 0) {\n                var parts = val.split(':');\n                return function (i, node) {\n                    return (i === 0 || i === node.table.body.length) ? parseFloat(parts[1]) : 0;\n                };\n            } else if (val.indexOf('$none') === 0) {\n                return function (i, node) {\n                    return 0;\n                };\n            } else if (val.indexOf('$notFirstAndLastColumn') === 0) {\n                var parts = val.split(':');\n                return function (i, node) {\n                    return (i === 0 || i === node.table.widths.length) ? 0 : parseFloat(parts[1]);\n                };\n            } else if (val.indexOf('$notFirst') === 0) {\n                var parts = val.split(':');\n                return function (i, node) {\n                    return i === 0 ? 0 : parseFloat(parts[1]);\n                };\n            } else if (val.indexOf('$amount') === 0) {\n                var parts = val.split(':');\n                return function (i, node) {\n                    return parseFloat(parts[1]);\n                };\n            } else if (val.indexOf('$primaryColor') === 0) {\n                var parts = val.split(':');\n                return NINJA.primaryColor || parts[1];\n            } else if (val.indexOf('$secondaryColor') === 0) {\n                var parts = val.split(':');\n                return NINJA.secondaryColor || parts[1];\n            }\n        }\n\n        // determine whether or not to show the header/footer\n        if (invoice.features.customize_invoice_design) {\n            if (key === 'header') {\n                return function(page, pages) {\n                    if (page === 1 || invoice.account.all_pages_header == '1') {\n                        if (invoice.features.remove_created_by) {\n                            return NINJA.updatePageCount(JSON.parse(JSON.stringify(val)), page, pages);\n                        } else {\n                            return val;\n                        }\n                    } else {\n                        return '';\n                    }\n                }\n            } else if (key === 'footer') {\n                return function(page, pages) {\n                    if (page === pages || invoice.account.all_pages_footer == '1') {\n                        if (invoice.features.remove_created_by) {\n                            return NINJA.updatePageCount(JSON.parse(JSON.stringify(val)), page, pages);\n                        } else {\n                            return val;\n                        }\n                    } else {\n                        return '';\n                    }\n                }\n            }\n        }\n\n        // check for markdown\n        if (key === 'text') {\n            val = NINJA.parseMarkdownText(val, true);\n        }\n\n        /*\n        if (key === 'stack') {\n            val = NINJA.parseMarkdownStack(val);\n            val = NINJA.parseMarkdownText(val, false);\n        }\n        */\n\n        return val;\n    }\n\n    // Add ninja logo to the footer\n    var dd = JSON.parse(javascript, jsonCallBack);\n    var designId = invoice.invoice_design_id;\n    if (!invoice.features.remove_created_by) {\n        var footer = (typeof dd.footer === 'function') ? dd.footer() : dd.footer;\n        if (footer) {\n            if (footer.hasOwnProperty('columns')) {\n                footer.columns.push({image: logoImages.imageLogo1, alignment: 'right', width: 130, margin: [0, 0, 0, 0]})\n            } else {\n                var foundColumns;\n                for (var i=0; i<footer.length; i++) {\n                    var item = footer[i];\n                    if (item.hasOwnProperty('columns')) {\n                        foundColumns = true;\n                        var columns = item.columns;\n                        if (columns[0].hasOwnProperty('stack')) {\n                            columns[0].stack.push({image: logoImages.imageLogo3, alignment: 'left', width: 130, margin: [40, 6, 0, 0]});\n                        } else {\n                            columns.push({image: logoImages.imageLogo1, alignment: 'right', width: 130, margin: [0, -40, 20, 0]})\n                        }\n                    }\n                }\n                if (!foundColumns) {\n                    footer.push({image: logoImages.imageLogo1, alignment: 'right', width: 130, margin: [0, 0, 10, 10]})\n                }\n            }\n        }\n    }\n\n    // support setting noWrap as a style\n    dd.styles.noWrap = {'noWrap': true};\n    dd.styles.discount = {'alignment': 'right'};\n    dd.styles.alignRight = {'alignment': 'right'};\n\n    // set page size\n    dd.pageSize = invoice.account.page_size;\n\n    if (invoice.watermark) {\n        dd.watermark = {\n            text: invoice.watermark,\n            color: 'black',\n            opacity: 0.04,\n        };\n    }\n\n    pdfMake.fonts = {}\n    fonts = window.invoiceFonts || invoice.invoice_fonts;\n\n    // Add only the loaded fonts\n    $.each(fonts, function(i,font){\n        addFont(font);\n    });\n\n\n    function addFont(font){\n        if(window.ninjaFontVfs[font.folder]){\n            folder = 'fonts/'+font.folder;\n            pdfMake.fonts[font.name] = {\n                normal: folder+'/'+font.normal,\n                italics: folder+'/'+font.italics,\n                bold: folder+'/'+font.bold,\n                bolditalics: folder+'/'+font.bolditalics\n            }\n        }\n    }\n\n    if(!dd.defaultStyle)dd.defaultStyle = {font:NINJA.bodyFont};\n    else if(!dd.defaultStyle.font)dd.defaultStyle.font = NINJA.bodyFont;\n\n    if (window.accountBackground) {\n        var origBackground = dd.background;\n        if (! origBackground) {\n            origBackground = [{\"image\": window.accountBackground, \"alignment\": \"center\"}];\n        }\n        dd.background = function(currentPage) {\n            var allPages = origBackground.length && origBackground[0].pages == 'all';\n            return currentPage == 1 || allPages ? origBackground : false;\n        }\n    } else {\n        // prevent unnecessarily showing blank image\n        dd.background = false;\n    }\n\n    doc = pdfMake.createPdf(dd);\n    doc.save = function(fileName) {\n        this.download(fileName);\n    };\n\n    return doc;\n}\n\nNINJA.updatePageCount = function(obj, pageNumber, pageCount)\n{\n    var pageNumberRegExp = new RegExp('\\\\$pageNumber', 'g');\n    var pageCountRegExp = new RegExp('\\\\$pageCount', 'g');\n\n    for (key in obj) {\n        if (!obj.hasOwnProperty(key)) {\n            continue;\n        }\n        var val = obj[key];\n        if (typeof val === 'string') {\n            val = val.replace(pageNumberRegExp, pageNumber);\n            val = val.replace(pageCountRegExp, pageCount);\n            obj[key] = val;\n        } else if (typeof val === 'object') {\n            obj[key] = NINJA.updatePageCount(val, pageNumber, pageCount);\n        }\n    }\n\n    return obj;\n}\n\nNINJA.decodeJavascript = function(invoice, javascript)\n{\n    var account = invoice.account;\n    var blankImage = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVQYV2NgYAAAAAMAAWgmWQ0AAAAASUVORK5CYII=';\n\n    // search/replace variables\n    var json = {\n        'accountName': account.name || ' ',\n        'accountLogo': window.accountLogo ? window.accountLogo : blankImage,\n        'accountBackground': window.accountBackground ? window.accountBackground : blankImage,\n        'accountDetails': NINJA.accountDetails(invoice),\n        'accountAddress': NINJA.accountAddress(invoice),\n        'invoiceDetails': NINJA.invoiceDetails(invoice),\n        'invoiceDetailsHeight': (NINJA.invoiceDetails(invoice).length * 16) + 16,\n        'invoiceLineItems': NINJA.invoiceLines(invoice),\n        'invoiceLineItemColumns': NINJA.invoiceColumns(invoice, javascript),\n        'taskLineItems': NINJA.invoiceLines(invoice, true),\n        'taskLineItemColumns': NINJA.invoiceColumns(invoice, javascript, true),\n        'invoiceDocuments' : NINJA.invoiceDocuments(invoice),\n        'quantityWidth': NINJA.quantityWidth(invoice),\n        'taxWidth': NINJA.taxWidth(invoice),\n        'clientDetails': NINJA.clientDetails(invoice),\n        'statementDetails': NINJA.statementDetails(invoice),\n        'notesAndTerms': NINJA.notesAndTerms(invoice),\n        'subtotals': NINJA.subtotals(invoice),\n        'subtotalsHeight': (NINJA.subtotals(invoice).length * 16) + 16,\n        'subtotalsWithoutBalance': NINJA.subtotals(invoice, true),\n        'subtotalsBalance': NINJA.subtotalsBalance(invoice),\n        'balanceDue': formatMoneyInvoice(invoice.balance_amount, invoice),\n        'invoiceFooter': NINJA.invoiceFooter(invoice),\n        'invoiceNumber': invoice.is_statement ? '' : (invoice.invoice_number || ' '),\n        'entityType': NINJA.entityType(invoice),\n        'entityTypeUC': NINJA.entityType(invoice).toUpperCase(),\n        'entityTaxType': invoice.is_statement ? invoiceLabels.statement : invoice.is_quote ? invoiceLabels.tax_quote : invoiceLabels.tax_invoice,\n        'fontSize': NINJA.fontSize,\n        'fontSizeLarger': NINJA.fontSize + 1,\n        'fontSizeLargest': NINJA.fontSize + 2,\n        'fontSizeSmaller': NINJA.fontSize - 1,\n        'bodyFont': NINJA.bodyFont,\n        'headerFont': NINJA.headerFont,\n        'signature': NINJA.signature(invoice),\n        'signatureBase64': NINJA.signatureImage(invoice),\n        'signatureDate': NINJA.signatureDate(invoice),\n        'invoiceTotal': formatMoneyInvoice(invoice.amount, invoice),\n    }\n\n    for (var key in json) {\n        // remove trailing commas for these fields\n        if (['quantityWidth', 'taxWidth'].indexOf(key) >= 0) {\n            var regExp = new RegExp('\"\\\\$'+key+'\",', 'g');\n            val = json[key];\n        } else {\n            var regExp = new RegExp('\"\\\\$'+key+'\"', 'g');\n            var val = JSON.stringify(json[key]);\n            val = doubleDollarSign(val);\n        }\n        javascript = javascript.replace(regExp, val);\n    }\n\n    // search/replace labels\n    var regExp = new RegExp('\"\\\\$\\\\\\w*?Label(UC)?(:)?(\\\\\\?)?\"', 'g');\n    var matches = javascript.match(regExp);\n\n    if (matches) {\n        for (var i=0; i<matches.length; i++) {\n            var match = matches[i];\n            field = match.substring(2, match.indexOf('Label'));\n            field = toSnakeCase(field);\n            var value = getDescendantProp(invoice, field);\n            if (match.indexOf('?') < 0 || value) {\n                if (invoice.partial > 0 && field == 'balance_due') {\n                    field = 'partial_due';\n                } else if (invoice.is_quote) {\n                    if (field == 'due_date') {\n                        field = 'valid_until';\n                    } else {\n                        field = field.replace('invoice', 'quote');\n                    }\n                }\n                if (invoice.is_statement) {\n                    if (field == 'your_invoice') {\n                        field = 'your_statement';\n                    } else if (field == 'invoice_issued_to') {\n                        field = 'statement_issued_to';\n                    } else if (field == 'invoice_to') {\n                        field = 'statement_to';\n                    }\n                } else if (invoice.is_delivery_note) {\n                    field = 'delivery_note';\n                } else if (invoice.balance_amount < 0) {\n                    if (field == 'your_invoice') {\n                        field = 'your_credit';\n                    } else if (field == 'invoice_issued_to') {\n                        field = 'credit_issued_to';\n                    } else if (field == 'invoice_to') {\n                        field = 'credit_to';\n                    }\n                }\n\n                var label = invoiceLabels[field];\n                if (match.indexOf('UC') >= 0) {\n                    label = label.toUpperCase();\n                }\n                if (match.indexOf(':') >= 0) {\n                    label = label + ':';\n                }\n            } else {\n                label = ' ';\n            }\n            javascript = javascript.replace(match, '\"'+label+'\"');\n        }\n    }\n\n    // search/replace values\n    var regExp = new RegExp('\\\\$[a-zA-Z][a-zA-Z0-9_\\\\.]*[Value]?', 'g');\n    var matches = javascript.match(regExp);\n\n    if (matches) {\n        for (var i=0; i<matches.length; i++) {\n            var match = matches[i];\n\n            // reserved words\n            if ([\n                '$none',\n                '$firstAndLast',\n                '$notFirstAndLastColumn',\n                '$notFirst',\n                '$amount',\n                '$primaryColor',\n                '$secondaryColor',\n            ].indexOf(match) >= 0) {\n                continue;\n            }\n\n            field = match.replace('$invoice.', '$');\n\n            // legacy style had 'Value' at the end\n            if (endsWith(field, 'Value')) {\n                field = field.substring(1, field.indexOf('Value'));\n            } else {\n                field = field.substring(1, field.length);\n            }\n\n            if (! field) {\n                continue;\n            }\n\n            field = toSnakeCase(field);\n\n            if (field == 'footer') {\n                field = 'invoice_footer';\n            } else if (match == '$account.phone') {\n                field = 'account.work_phone';\n            } else if (match == '$client.phone') {\n                field = 'client.phone';\n            }\n\n            var value = getDescendantProp(invoice, field) || ' ';\n            value = doubleDollarSign(value) + '';\n            value = value.replace(/\\n/g, \"\\\\n\").replace(/\\r/g, \"\\\\r\");\n\n            if (['amount', 'partial', 'client.balance', 'client.paid_to_date'].indexOf(field) >= 0) {\n                value = formatMoneyInvoice(value, invoice);\n            }\n\n            if (['$pageNumber', '$pageCount'].indexOf(match) == -1) {\n                javascript = javascript.replace(match, value);\n            }\n        }\n    }\n\n    return javascript;\n}\n\nNINJA.statementDetails = function(invoice) {\n    if (! invoice.is_statement) {\n        return false;\n    }\n\n    var data = {\n        \"stack\": []\n    };\n\n    var table = {\n        \"style\": \"invoiceLineItemsTable\",\n        \"margin\": [0, 20, 0, 16],\n        \"table\": {\n            \"headerRows\": 1,\n            \"widths\": false,\n            \"body\": false,\n        },\n        \"layout\": {\n            \"hLineWidth\": \"$notFirst:.5\",\n            \"vLineWidth\": \"$none\",\n            \"hLineColor\": \"#D8D8D8\",\n            \"paddingLeft\": \"$amount:8\",\n            \"paddingRight\": \"$amount:8\",\n            \"paddingTop\": \"$amount:14\",\n            \"paddingBottom\": \"$amount:14\"\n        }\n    };\n\n    var subtotals =   {\n        \"columns\": [\n            {\n                \"text\": \" \",\n                \"width\": \"60%\",\n            },\n            {\n                \"table\": {\n                    \"widths\": [\n                        \"*\",\n                        \"40%\"\n                    ],\n                    \"body\": false,\n                },\n                \"margin\": [0, 0, 0, 16],\n                \"layout\": {\n                    \"hLineWidth\": \"$none\",\n                    \"vLineWidth\": \"$none\",\n                    \"paddingLeft\": \"$amount:34\",\n                    \"paddingRight\": \"$amount:8\",\n                    \"paddingTop\": \"$amount:4\",\n                    \"paddingBottom\": \"$amount:4\"\n                }\n            }\n        ]\n    };\n\n\n    var hasPayments = false;\n    var hasAging = false;\n    var paymentTotal = 0;\n    for (var i = 0; i < invoice.invoice_items.length; i++) {\n        var item = invoice.invoice_items[i];\n        if (item.invoice_item_type_id == 3) {\n            paymentTotal += item.cost;\n            hasPayments = true;\n        } else if (item.invoice_item_type_id == 4) {\n            hasAging = true;\n        }\n    }\n\n    var clone = JSON.parse(JSON.stringify(table));\n    clone.table.body = NINJA.prepareDataTable(NINJA.statementInvoices(invoice), 'invoiceItems');\n    clone.table.widths = [\"22%\", \"22%\", \"22%\", \"17%\", \"17%\"];\n    data.stack.push(clone);\n\n    var clone = JSON.parse(JSON.stringify(subtotals));\n    clone.columns[1].table.body = [[\n        { text: invoiceLabels.balance_due, style: ['subtotalsLabel', 'subtotalsBalanceDueLabel'] },\n        { text: formatMoneyInvoice(invoice.balance_amount, invoice), style: ['subtotals', 'subtotalsBalanceDue', 'noWrap'] }\n    ]];\n    data.stack.push(clone);\n\n    if (hasPayments) {\n        var clone = JSON.parse(JSON.stringify(table));\n        clone.table.body = NINJA.prepareDataTable(NINJA.statementPayments(invoice), 'invoiceItems');\n        clone.table.widths = [\"22%\", \"22%\", \"39%\", \"17%\"];\n        data.stack.push(clone);\n\n        var clone = JSON.parse(JSON.stringify(subtotals));\n        clone.columns[1].table.body = [[\n            { text: invoiceLabels.amount_paid, style: ['subtotalsLabel', 'subtotalsBalanceDueLabel'] },\n            { text: formatMoneyInvoice(paymentTotal, invoice), style: ['subtotals', 'subtotalsBalanceDue', 'noWrap'] }\n        ]];\n        data.stack.push(clone);\n    }\n\n    if (hasAging) {\n        var clone = JSON.parse(JSON.stringify(table));\n        clone.table.body = NINJA.prepareDataTable(NINJA.statementAging(invoice), 'invoiceItems');\n        clone.table.widths = [\"20%\", \"20%\", \"20%\", \"20%\", \"20%\"];\n        data.stack.push(clone);\n    }\n\n    return data;\n}\n\nNINJA.statementInvoices = function(invoice) {\n    var grid = [[]];\n    grid[0].push({text: invoiceLabels.invoice_number, style: ['tableHeader', 'itemTableHeader', 'firstColumn']});\n    grid[0].push({text: invoiceLabels.invoice_date, style: ['tableHeader', 'invoiceDateTableHeader']});\n    grid[0].push({text: invoiceLabels.due_date, style: ['tableHeader', 'dueDateTableHeader']});\n    grid[0].push({text: invoiceLabels.total, style: ['tableHeader', 'totalTableHeader']});\n    grid[0].push({text: invoiceLabels.balance, style: ['tableHeader', 'balanceTableHeader', 'lastColumn']});\n\n    var counter = 0;\n    for (var i = 0; i < invoice.invoice_items.length; i++) {\n        var item = invoice.invoice_items[i];\n        if (item.invoice_item_type_id != 1) {\n            continue;\n        }\n        var rowStyle = (counter++ % 2 == 0) ? 'odd' : 'even';\n        grid.push([\n            {text: item.product_key, style:['invoiceNumber', 'productKey', rowStyle, 'firstColumn']},\n            {text: item.custom_value1 && item.custom_value1 != '0000-00-00' ? moment(item.custom_value1).format(invoice.account.date_format ? invoice.account.date_format.format_moment : 'MMM D, YYYY') : ' ', style:['invoiceDate', rowStyle]},\n            {text: item.custom_value2 && item.custom_value2 != '0000-00-00' ? moment(item.custom_value2).format(invoice.account.date_format ? invoice.account.date_format.format_moment : 'MMM D, YYYY') : ' ', style:['dueDate', rowStyle]},\n            {text: formatMoneyInvoice(item.notes, invoice), style:['subtotals', rowStyle]},\n            {text: formatMoneyInvoice(item.cost, invoice), style:['lineTotal', rowStyle, 'lastColumn']},\n        ]);\n    }\n\n    return grid;\n}\n\nNINJA.statementPayments = function(invoice) {\n    var grid = [[]];\n\n    grid[0].push({text: invoiceLabels.invoice_number, style: ['tableHeader', 'itemTableHeader', 'firstColumn']});\n    grid[0].push({text: invoiceLabels.payment_date, style: ['tableHeader', 'invoiceDateTableHeader']});\n    grid[0].push({text: invoiceLabels.method, style: ['tableHeader', 'dueDateTableHeader']});\n    //grid[0].push({text: invoiceLabels.reference, style: ['tableHeader', 'totalTableHeader']});\n    grid[0].push({text: invoiceLabels.amount, style: ['tableHeader', 'balanceTableHeader', 'lastColumn']});\n\n    var counter = 0;\n    for (var i = 0; i < invoice.invoice_items.length; i++) {\n        var item = invoice.invoice_items[i];\n        if (item.invoice_item_type_id != 3) {\n            continue;\n        }\n        var rowStyle = (counter++ % 2 == 0) ? 'odd' : 'even';\n        grid.push([\n            {text: item.product_key, style:['invoiceNumber', 'productKey', rowStyle, 'firstColumn']},\n            {text: item.custom_value1 && item.custom_value1 != '0000-00-00' ? moment(item.custom_value1).format(invoice.account.date_format ? invoice.account.date_format.format_moment : 'MMM D, YYYY') : ' ', style:['invoiceDate', rowStyle]},\n            {text: item.custom_value2 ? item.custom_value2 : ' ', style:['dueDate', rowStyle]},\n            //{text: item.transaction_reference, style:['subtotals', rowStyle]},\n            {text: formatMoneyInvoice(item.cost, invoice), style:['lineTotal', rowStyle, 'lastColumn']},\n        ]);\n    }\n\n    return grid;\n}\nNINJA.statementAging = function(invoice) {\n    var grid = [[]];\n\n    grid[0].push({text: '0 - 30', style: ['tableHeader', 'alignRight', 'firstColumn']});\n    grid[0].push({text: '30 - 60', style: ['tableHeader', 'alignRight']});\n    grid[0].push({text: '60 - 90', style: ['tableHeader', 'alignRight']});\n    grid[0].push({text: '90 - 120', style: ['tableHeader', 'alignRight']});\n    grid[0].push({text: '120+', style: ['tableHeader', 'alignRight', 'lastColumn']});\n\n    for (var i = 0; i < invoice.invoice_items.length; i++) {\n        var item = invoice.invoice_items[i];\n        if (item.invoice_item_type_id != 4) {\n            continue;\n        }\n        grid.push([\n            {text: formatMoneyInvoice(item.product_key, invoice), style:['subtotals', 'odd', 'firstColumn']},\n            {text: formatMoneyInvoice(item.notes, invoice), style:['subtotals', 'odd']},\n            {text: formatMoneyInvoice(item.custom_value1, invoice), style:['subtotals', 'odd']},\n            {text: formatMoneyInvoice(item.custom_value1, invoice), style:['subtotals', 'odd']},\n            {text: formatMoneyInvoice(item.cost, invoice), style:['subtotals', 'odd', 'lastColumn']},\n        ]);\n    }\n\n    return grid;\n}\n\nNINJA.signature = function(invoice) {\n    var invitation = NINJA.getSignatureInvitation(invoice);\n    if (invitation) {\n        return {\n            \"stack\": [\n                {\n                    \"image\": \"$signatureBase64\",\n                    \"margin\": [200, 10, 0, 0]\n                },\n                {\n                    \"canvas\": [{\n                        \"type\": \"line\",\n                        \"x1\": 200,\n                        \"y1\": -25,\n                        \"x2\": 504,\n                        \"y2\": -25,\n                        \"lineWidth\": 1,\n                        \"lineColor\": \"#888888\"\n                    }]\n                },\n                {\n                    \"text\": [invoiceLabels.date, \": \", \"$signatureDate\"],\n                    \"margin\": [200, -20, 0, 0]\n                }\n            ]\n        };\n    } else {\n        return '';\n    }\n}\n\nNINJA.signatureImage = function(invoice) {\n    var blankImage = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVQYV2NgYAAAAAMAAWgmWQ0AAAAASUVORK5CYII=';\n    var invitation = NINJA.getSignatureInvitation(invoice);\n    return invitation ? invitation.signature_base64 : blankImage;\n}\n\nNINJA.signatureDate = function(invoice) {\n    var invitation = NINJA.getSignatureInvitation(invoice);\n    return invitation ? NINJA.formatDateTime(invitation.signature_date, invoice.account) : '';\n}\n\nNINJA.getSignatureInvitation = function(invoice) {\n    if (! invoice.invitations || ! invoice.invitations.length) {\n        return false;\n    }\n\n    if (! parseInt(invoice.account.signature_on_pdf)) {\n        return false;\n    }\n\n    for (var i=0; i<invoice.invitations.length; i++) {\n        var invitation = invoice.invitations[i];\n        if (invitation.signature_base64) {\n            return invitation;\n        }\n    }\n\n    return false;\n}\n\nNINJA.formatDateTime = function(date, account) {\n    var format = account.datetime_format ? account.datetime_format.format_moment : 'LLL';\n    var timezone = account.timezone ? account.timezone.name : 'US/Eastern';\n\n    return date ? moment.utc(date).tz(timezone).format(format) : '';\n}\n\nNINJA.entityType = function(invoice)\n{\n    if (invoice.is_delivery_note) {\n        return invoiceLabels.delivery_note;\n    } else if (invoice.is_statement) {\n        return invoiceLabels.statement;\n    } else if (invoice.is_quote) {\n        return invoiceLabels.quote;\n    } else if (invoice.balance_amount < 0) {\n        return invoiceLabels.credit_note;\n    } else if (hasPayments) {\n        return \"RECEIPT\";\n    } else {\n        return invoiceLabels.invoice;\n    }\n}\n\nNINJA.notesAndTerms = function(invoice)\n{\n    var data = [];\n\n    if (invoice.public_notes) {\n        data.push({stack:[{text: invoice.is_recurring ? processVariables(invoice.public_notes) : invoice.public_notes, style: ['notes']}]});\n        data.push({text:' '});\n    }\n\n    if (invoice.terms) {\n        data.push({text:invoiceLabels.terms, style: ['termsLabel']});\n        data.push({stack:[{text: invoice.is_recurring ? processVariables(invoice.terms) : invoice.terms, style: ['terms']}]});\n    }\n\n    return NINJA.prepareDataList(data, 'notesAndTerms');\n}\n\nNINJA.invoiceColumns = function(invoice, design, isTasks)\n{\n    var account = invoice.account;\n    var columns = [];\n    var fields = NINJA.productFields(invoice, isTasks);\n    var hasDescription = fields.indexOf('product.description') >= 0;\n    var hasPadding = design.indexOf('\"pageMargins\":[0') == -1 && design.indexOf('\"pageMargins\": [0') == -1;\n\n    for (var i=0; i<fields.length; i++) {\n        var field = fields[i];\n        var width = 0;\n\n        if (invoice.is_delivery_note) {\n            var skipFields = [\n                'product.unit_cost',\n                'product.rate',\n                'product.tax',\n                'product.line_total',\n            ];\n            if (skipFields.indexOf(field) >= 0) {\n                continue;\n            }\n        }\n\n        if (field == 'product.custom_value1') {\n            if (invoice.has_custom_item_value1) {\n                width = 10;\n            } else {\n                continue;\n            }\n        } else if (field == 'product.custom_value2') {\n            if (invoice.has_custom_item_value2) {\n                width = 10;\n            } else {\n                continue;\n            }\n        } else if (field == 'product.tax') {\n            if (invoice.has_item_taxes) {\n                width = 15;\n            } else {\n                continue;\n            }\n        } else if (field == 'product.discount') {\n            if (invoice.has_item_discounts) {\n                width = 15;\n            } else {\n                continue;\n            }\n        } else if (field == 'product.description') {\n            width = 0;\n        } else {\n            width = 14;\n        }\n\n        if (width) {\n            // make the first and last columns of the Bold design a bit wider\n            if (! hasPadding) {\n                if (i == 0 || i == fields.length - 1) {\n                    width += 8;\n                }\n            }\n            if (! hasDescription) {\n                width = '*';\n            } else {\n                width += '%';\n            }\n        } else {\n            width = '*';\n        }\n\n        columns.push(width)\n    }\n\n    //console.log(columns);\n    return columns;\n}\n\nNINJA.invoiceFooter = function(invoice)\n{\n    var footer = invoice.invoice_footer;\n\n    if (invoice.is_recurring) {\n        footer = processVariables(footer);\n    }\n\n    if (!invoice.features.invoice_settings && invoice.invoice_design_id == 3) {\n        return footer ? footer.substring(0, 200) : ' ';\n    } else {\n        return footer || ' ';\n    }\n}\n\nNINJA.quantityWidth = function(invoice)\n{\n    var fields = NINJA.productFields(invoice);\n    return fields.indexOf('product.quantity') >= 0 ? '\"14%\", ' : '';\n}\n\nNINJA.taxWidth = function(invoice)\n{\n    var fields = NINJA.productFields(invoice);\n    return invoice.has_item_taxes && fields.indexOf('product.tax') >= 0 ? '\"14%\", ' : '';\n}\n\nNINJA.productFields = function(invoice, isTasks) {\n    var account = invoice.account;\n    var allFields = JSON.parse(account.invoice_fields);\n\n    if (allFields) {\n        if (isTasks && allFields.task_fields && allFields.task_fields.length) {\n            return allFields.task_fields;\n        } else if (! isTasks && allFields.product_fields && allFields.product_fields.length) {\n            return allFields.product_fields;\n        }\n    }\n\n    var fields = [\n        isTasks ? 'product.service' : 'product.item',\n        'product.description',\n        'product.custom_value1',\n        'product.custom_value2',\n        isTasks ? 'product.rate' : 'product.unit_cost',\n        isTasks ? 'product.hours' : 'product.quantity',\n        'product.tax',\n        'product.line_total',\n    ];\n\n    // add backwards compatibility for 'hide qty' setting\n    if (invoice.account.hide_quantity == '1' && ! isTasks) {\n        fields.splice(5, 1);\n    }\n\n    return fields;\n}\n\nNINJA.invoiceLines = function(invoice, isSecondTable) {\n    var account = invoice.account;\n    var total = 0;\n    var shownItem = false;\n    var isTasks = isSecondTable || (invoice.hasTasks && !invoice.hasStandard);\n    var grid = [[]];\n    var styles = ['tableHeader'];\n    var skipFields = [\n        'product.unit_cost',\n        'product.rate',\n        'product.tax',\n        'product.line_total',\n        'product.discount',\n    ];\n\n    if (isSecondTable && invoice.hasStandard) {\n        styles.push('secondTableHeader');\n    }\n\n    var fields = NINJA.productFields(invoice, isTasks);\n    var hasDescription = fields.indexOf('product.description') >= 0;\n\n    for (var i=0; i<fields.length; i++) {\n        var field = fields[i].split('.')[1]; // split to remove 'product.'\n\n        if (invoice.is_delivery_note && skipFields.indexOf(fields[i]) >= 0) {\n            continue;\n        }\n\n        var headerStyles = styles.concat([snakeToCamel(field), snakeToCamel(field) + 'TableHeader']);\n        var value = invoiceLabels[field];\n\n        if (field == 'custom_value1') {\n            if (invoice.has_custom_item_value1) {\n                value = NINJA.getCustomLabel(account.custom_fields.product1);\n            } else {\n                continue;\n            }\n        } else if (field == 'custom_value2') {\n            if (invoice.has_custom_item_value2) {\n                value = NINJA.getCustomLabel(account.custom_fields.product2);\n            } else {\n                continue;\n            }\n        } else if (field == 'tax' && ! invoice.has_item_taxes) {\n            continue;\n        } else if (field == 'discount' && ! invoice.has_item_discounts) {\n            continue;\n        } else if (field == 'unit_cost' || field == 'rate' || field == 'hours') {\n            headerStyles.push('cost');\n        }\n\n        if (i == 0) {\n            headerStyles.push('firstColumn');\n        } else if (i == fields.length - 1) {\n            headerStyles.push('lastColumn');\n        }\n\n        grid[0].push({text: value, style: headerStyles});\n    }\n\n    for (var i=0; i<invoice.invoice_items.length; i++) {\n        var row = [];\n        var item = invoice.invoice_items[i];\n        var cost = NINJA.parseFloat(item.cost) ? formatMoneyInvoice(NINJA.parseFloat(item.cost), invoice, null, getPrecision(NINJA.parseFloat(item.cost))) : ' ';\n        var qty = NINJA.parseFloat(item.qty) ? formatMoneyInvoice(NINJA.parseFloat(item.qty), invoice, 'none', getPrecision(NINJA.parseFloat(item.qty))) + '' : ' ';\n        var discount = roundToTwo(NINJA.parseFloat(item.discount));\n        var notes = item.notes;\n        var productKey = item.product_key;\n        var tax1 = '';\n        var tax2 = '';\n        var customValue1 = item.custom_value1;\n        var customValue2 = item.custom_value2;\n\n        if (isTasks) {\n            if (item.invoice_item_type_id != 2) {\n                continue;\n            }\n        } else {\n            if (item.invoice_item_type_id == 2) {\n                continue;\n            }\n        }\n\n        if (parseFloat(item.tax_rate1) != 0) {\n            tax1 = parseFloat(item.tax_rate1);\n        }\n        if (parseFloat(item.tax_rate2) != 0) {\n            tax2 = parseFloat(item.tax_rate2);\n        }\n\n        // show at most one blank line\n        if (shownItem && !notes && !productKey && !item.cost) {\n            continue;\n        }\n\n        shownItem = true;\n\n        // process date variables\n        if (invoice.is_recurring) {\n            notes = processVariables(notes);\n            productKey = processVariables(productKey);\n            customValue1 = processVariables(item.custom_value1);\n            customValue2 = processVariables(item.custom_value2);\n        }\n\n        var lineTotal = roundSignificant(NINJA.parseFloat(item.cost) * NINJA.parseFloat(item.qty));\n\n        if (discount != 0) {\n            if (parseInt(invoice.is_amount_discount)) {\n                lineTotal -= discount;\n            } else {\n                lineTotal -= (lineTotal * discount / 100);\n            }\n        }\n\n        if (account.include_item_taxes_inline == '1') {\n            var taxAmount1 = 0;\n            var taxAmount2 = 0;\n            if (tax1) {\n                taxAmount1 = roundToTwo(lineTotal * tax1 / 100);\n            }\n            if (tax2) {\n                taxAmount2 = roundToTwo(lineTotal * tax2 / 100);\n            }\n            lineTotal += taxAmount1 + taxAmount2;\n        }\n\n        if (lineTotal != 0) {\n            lineTotal = formatMoneyInvoice(lineTotal, invoice);\n        }\n        rowStyle = (grid.length % 2 == 0) ? 'even' : 'odd';\n\n        for (var j=0; j<fields.length; j++) {\n            var field = fields[j].split('.')[1]; // split to remove 'product.'\n\n            if (invoice.is_delivery_note && skipFields.indexOf(fields[j]) >= 0) {\n                continue;\n            }\n\n            var value = item[field];\n            var styles = [snakeToCamel(field), rowStyle];\n\n            if (field == 'custom_value1' && ! invoice.has_custom_item_value1) {\n                continue;\n            } else if (field == 'custom_value2' && ! invoice.has_custom_item_value2) {\n                continue;\n            } else if (field == 'tax' && ! invoice.has_item_taxes) {\n                continue;\n            } else if (field == 'discount' && ! invoice.has_item_discounts) {\n                continue;\n            }\n\n            if (field == 'item' || field == 'service') {\n                value = productKey;\n                styles.push('productKey');\n            } else if (field == 'description') {\n                value = notes;\n            } else if (field == 'unit_cost' || field == 'rate') {\n                value = cost;\n                styles.push('cost');\n            } else if (field == 'quantity' || field == 'hours') {\n                value = qty;\n                if (field == 'hours') {\n                    styles.push('cost');\n                }\n            } else if (field == 'custom_value1') {\n                value = customValue1;\n            } else if (field == 'custom_value2') {\n                value = customValue2;\n            } else if (field == 'discount') {\n                if (NINJA.parseFloat(discount)) {\n                    if (parseInt(invoice.is_amount_discount)) {\n                        value = formatMoneyInvoice(discount, invoice);\n                    } else {\n                        if (discount) {\n                            value = discount + '%';\n                        }\n                    }\n                } else {\n                    value = '';\n                }\n            } else if (field == 'tax') {\n                value = ' ';\n                if (item.tax_name1) {\n                    value += (tax1 || '0') + '%';\n                }\n                if (item.tax_name2) {\n                    if (item.tax_name1) {\n                        value += '  ';\n                    }\n                    value += (tax2 || '0') + '%';\n                }\n            } else if (field == 'line_total') {\n                value = lineTotal;\n            }\n\n            if (j == 0) {\n                styles.push('firstColumn');\n            } else if (j == fields.length - 1) {\n                styles.push('lastColumn');\n            }\n\n            row.push({text:value || ' ', style:styles});\n        }\n\n        grid.push(row);\n    }\n\n    //console.log(JSON.stringify(grid));\n    return NINJA.prepareDataTable(grid, 'invoiceItems');\n}\n\nNINJA.invoiceDocuments = function(invoice) {\n    if (invoice.account.invoice_embed_documents != '1') {\n        return [];\n    }\n\n    var j = 0;\n    var stack = [];\n    var stackItem = null;\n\n    if (invoice.documents) {\n        for (var i = 0; i < invoice.documents.length; i++) {\n            addDoc(invoice.documents[i]);\n        }\n    }\n\n    if (invoice.expenses) {\n        for (var i = 0; i < invoice.expenses.length; i++) {\n            var expense = invoice.expenses[i];\n            for (var j = 0; j < expense.documents.length; j++) {\n                addDoc(expense.documents[j]);\n            }\n        }\n    }\n\n    function addDoc(document){\n        var path = document.base64;\n\n        if(!path)path = 'docs/'+document.public_id+'/'+document.name;\n        if(path && (window.pdfMake.vfs[path] || document.base64)){\n            // Only embed if we actually have an image for it\n            if(j%3==0){\n                stackItem = {columns:[]};\n                stack.push(stackItem);\n            }\n            stackItem.columns.push({stack:[{image:path,style:'invoiceDocument',fit:[150,150]}], width:175})\n            j++;\n        }\n    }\n\n    return stack.length?{stack:stack}:[];\n}\n\nNINJA.subtotals = function(invoice, hideBalance)\n{\n    if (! invoice || invoice.is_delivery_note) {\n        return [[]];\n    }\n\n    var account = invoice.account;\n    var data = [];\n    data.push([{text: invoiceLabels.subtotal, style: ['subtotalsLabel', 'subtotalLabel']}, {text: formatMoneyInvoice(invoice.subtotal_amount, invoice), style: ['subtotals', 'subtotal']}]);\n\n    if (invoice.discount_amount != 0) {\n        data.push([{text: invoiceLabels.discount , style: ['subtotalsLabel', 'discountLabel']}, {text: formatMoneyInvoice(invoice.discount_amount, invoice), style: ['subtotals', 'discount']}]);\n    }\n\n    var customValue1 = NINJA.parseFloat(invoice.custom_value1);\n    var customValue1Label = account.custom_fields.invoice1 || invoiceLabels.surcharge;\n\n    var customValue2 = NINJA.parseFloat(invoice.custom_value2);\n    var customValue2Label = account.custom_fields.invoice2 || invoiceLabels.surcharge;\n\n    if (customValue1 && invoice.custom_taxes1 == '1') {\n        data.push([{text: customValue1Label, style: ['subtotalsLabel', 'customTax1Label']}, {text: formatMoneyInvoice(invoice.custom_value1, invoice), style: ['subtotals', 'customTax1']}]);\n    }\n    if (customValue2 && invoice.custom_taxes2 == '1') {\n        data.push([{text: customValue2Label, style: ['subtotalsLabel', 'customTax2Label']}, {text: formatMoneyInvoice(invoice.custom_value2, invoice), style: ['subtotals', 'customTax2']}]);\n    }\n\n    for (var key in invoice.item_taxes) {\n        if (invoice.item_taxes.hasOwnProperty(key)) {\n            var taxRate = invoice.item_taxes[key];\n            var taxStr = taxRate.name + ' ' + (taxRate.rate*1).toString() + '%';\n            data.push([{text: taxStr, style: ['subtotalsLabel', 'taxLabel']}, {text: formatMoneyInvoice(taxRate.amount, invoice), style: ['subtotals', 'tax']}]);\n        }\n    }\n\n    if (parseFloat(invoice.tax_rate1 || 0) != 0 || invoice.tax_name1) {\n        var taxStr = invoice.tax_name1 + ' ' + (invoice.tax_rate1*1).toString() + '%';\n        data.push([{text: taxStr, style: ['subtotalsLabel', 'tax1Label']}, {text: formatMoneyInvoice(invoice.tax_amount1, invoice), style: ['subtotals', 'tax1']}]);\n    }\n    if (parseFloat(invoice.tax_rate2 || 0) != 0 || invoice.tax_name2) {\n        var taxStr = invoice.tax_name2 + ' ' + (invoice.tax_rate2*1).toString() + '%';\n        data.push([{text: taxStr, style: ['subtotalsLabel', 'tax2Label']}, {text: formatMoneyInvoice(invoice.tax_amount2, invoice), style: ['subtotals', 'tax2']}]);\n    }\n\n    if (customValue1 && invoice.custom_taxes1 != '1') {\n        data.push([{text: customValue1Label, style: ['subtotalsLabel', 'custom1Label']}, {text: formatMoneyInvoice(invoice.custom_value1, invoice), style: ['subtotals', 'custom1']}]);\n    }\n    if (customValue2 && invoice.custom_taxes2 != '1') {\n        data.push([{text: customValue2Label, style: ['subtotalsLabel', 'custom2Label']}, {text: formatMoneyInvoice(invoice.custom_value2, invoice), style: ['subtotals', 'custom2']}]);\n    }\n\n    var paid = invoice.amount - invoice.balance;\n    if (!invoice.is_quote && invoice.balance_amount >= 0 && (invoice.account.hide_paid_to_date != '1' || paid)) {\n        data.push([{text:invoiceLabels.paid_to_date, style: ['subtotalsLabel', 'paidToDateLabel']}, {text:formatMoneyInvoice(paid, invoice), style: ['subtotals', 'paidToDate']}]);\n    }\n\n    var isPartial = NINJA.parseFloat(invoice.partial);\n\n    if (!hideBalance || isPartial) {\n        data.push([\n            { text: invoice.is_quote || invoice.balance_amount < 0 ? invoiceLabels.total : invoiceLabels.balance_due, style: ['subtotalsLabel', isPartial ? '' : 'subtotalsBalanceDueLabel'] },\n            { text: formatMoneyInvoice(invoice.total_amount, invoice), style: ['subtotals', isPartial ? '' : 'subtotalsBalanceDue'] }\n        ]);\n    }\n\n    if (!hideBalance) {\n        if (isPartial) {\n            data.push([\n                { text: invoiceLabels.partial_due, style: ['subtotalsLabel', 'subtotalsBalanceDueLabel'] },\n                { text: formatMoneyInvoice(invoice.balance_amount, invoice), style: ['subtotals', 'subtotalsBalanceDue'] }\n            ]);\n        }\n    }\n\n    return NINJA.prepareDataPairs(data, 'subtotals');\n}\n\nNINJA.subtotalsBalance = function(invoice) {\n    if (invoice.is_delivery_note) {\n        return [[]];\n    }\n\n    var isPartial = NINJA.parseFloat(invoice.partial);\n    return [[\n        {text: isPartial ? invoiceLabels.partial_due : (invoice.is_quote || invoice.balance_amount < 0 ? invoiceLabels.total : invoiceLabels.balance_due), style:['subtotalsLabel', 'subtotalsBalanceDueLabel']},\n        {text: formatMoneyInvoice(invoice.balance_amount, invoice), style:['subtotals', 'subtotalsBalanceDue']}\n    ]];\n}\n\nNINJA.accountDetails = function(invoice) {\n    var account = invoice.account;\n    if (invoice.features.invoice_settings && account.invoice_fields) {\n        var fields = JSON.parse(account.invoice_fields).account_fields1;\n    } else {\n        var fields = [\n            'account.company_name',\n            'account.id_number',\n            'account.vat_number',\n            'account.website',\n            'account.email',\n            'account.phone',\n        ];\n    }\n\n    var data = [];\n\n    for (var i=0; i < fields.length; i++) {\n        var field = fields[i];\n        var value = NINJA.renderField(invoice, field);\n        if (value) {\n            data.push(value);\n        }\n    }\n\n    return NINJA.prepareDataList(data, 'accountDetails');\n}\n\nNINJA.accountAddress = function(invoice) {\n    var account = invoice.account;\n    if (invoice.features.invoice_settings && account.invoice_fields) {\n        var fields = JSON.parse(account.invoice_fields).account_fields2;\n    } else {\n        var fields = [\n            'account.address1',\n            'account.address2',\n            'account.city_state_postal',\n            'account.country',\n            'account.custom_value1',\n            'account.custom_value2',\n        ]\n    }\n\n    var data = [];\n\n    for (var i=0; i < fields.length; i++) {\n        var field = fields[i];\n        var value = NINJA.renderField(invoice, field);\n        if (value) {\n            data.push(value);\n        }\n    }\n\n    return NINJA.prepareDataList(data, 'accountAddress');\n}\n\nNINJA.invoiceDetails = function(invoice) {\n\n    var account = invoice.account;\n    if (invoice.features.invoice_settings && account.invoice_fields) {\n        var fields = JSON.parse(account.invoice_fields).invoice_fields;\n    } else {\n        var fields = [\n            'invoice.invoice_number',\n            'invoice.po_number',\n            'invoice.invoice_date',\n            'invoice.due_date',\n            'invoice.balance_due',\n            'invoice.partial_due',\n            'invoice.custom_text_value1',\n            'invoice.custom_text_value2',\n        ];\n    }\n    var data = [];\n\n    for (var i=0; i < fields.length; i++) {\n        var field = fields[i];\n        var value = NINJA.renderField(invoice, field, true);\n        if (value) {\n            data.push(value);\n        }\n    }\n\n    return NINJA.prepareDataPairs(data, 'invoiceDetails');\n}\n\n\nNINJA.renderField = function(invoice, field, twoColumn) {\n    if (invoice.is_delivery_note) {\n        var skipFields = [\n            'invoice.due_date',\n            'invoice.balance_due',\n            'invoice.partial_due',\n        ];\n        if (skipFields.indexOf(field) >= 0) {\n            return false;\n        }\n    }\n\n    var client = invoice.client;\n    if (!client) {\n        return false;\n    }\n    var account = invoice.account;\n    var contact = invoice.contact || client.contacts[0];\n    var clientName = client.name || (contact.first_name || contact.last_name ? ((contact.first_name || '') + ' ' + (contact.last_name || '')) : contact.email);\n\n    var label = false;\n    var value = false;\n\n    if (field == 'client.client_name') {\n        value = clientName || ' ';\n    } else if (field == 'client.contact_name') {\n        value = (contact.first_name || contact.last_name) ? (contact.first_name || '') + ' ' + (contact.last_name || '') : false;\n    } else if (field == 'client.id_number') {\n        value = client.id_number;\n        if (invoiceLabels.id_number_orig) {\n            label = invoiceLabels.id_number;\n        }\n    } else if (field == 'client.vat_number') {\n        value = client.vat_number;\n        if (invoiceLabels.vat_number_orig) {\n            label = invoiceLabels.vat_number;\n        }\n    } else if (field == 'client.address1') {\n        if (invoice.is_delivery_note && client.shipping_address1) {\n            value = client.shipping_address1;\n        } else {\n            value = client.address1;\n        }\n    } else if (field == 'client.address2') {\n        if (invoice.is_delivery_note && client.shipping_address1) {\n            value = client.shipping_address2;\n        } else {\n            value = client.address2;\n        }\n    } else if (field == 'client.city_state_postal') {\n        var cityStatePostal = '';\n        if (invoice.is_delivery_note && client.shipping_address1) {\n            if (client.shipping_city || client.shipping_state || client.shipping_postal_code) {\n                var swap = client.shipping_country && client.shipping_country.swap_postal_code;\n                cityStatePostal = formatAddress(client.shipping_city, client.shipping_state, client.shipping_postal_code, swap);\n            }\n        } else {\n            if (client.city || client.state || client.postal_code) {\n                var swap = client.country && client.country.swap_postal_code;\n                cityStatePostal = formatAddress(client.city, client.state, client.postal_code, swap);\n            }\n        }\n        value = cityStatePostal;\n    } else if (field == 'client.postal_city_state') {\n        var postalCityState = '';\n        if (invoice.is_delivery_note && client.shipping_address1) {\n            if (client.shipping_city || client.shipping_state || client.shipping_postal_code) {\n                postalCityState = formatAddress(client.shipping_city, client.shipping_state, client.shipping_postal_code, true);\n            }\n        } else {\n            if (client.city || client.state || client.postal_code) {\n                postalCityState = formatAddress(client.city, client.state, client.postal_code, true);\n            }\n        }\n        value = postalCityState;\n    } else if (field == 'client.country') {\n        if (invoice.is_delivery_note && client.shipping_address1) {\n            value = client.shipping_country ? client.shipping_country.name : '';\n        } else {\n            value = client.country ? client.country.name : '';\n        }\n    } else if (field == 'client.website') {\n        value = client.website;\n    } else if (field == 'client.email') {\n        value = contact.email == clientName ? '' : contact.email;\n    } else if (field == 'client.phone') {\n        value = contact.phone;\n    } else if (field == 'client.work_phone') {\n        value = client.work_phone;\n    } else if (field == 'client.custom_value1') {\n        if (account.custom_fields.client1 && client.custom_value1) {\n            label = NINJA.getCustomLabel(account.custom_fields.client1);\n            value = client.custom_value1;\n        }\n    } else if (field == 'client.custom_value2') {\n        if (account.custom_fields.client2 && client.custom_value2) {\n            label = NINJA.getCustomLabel(account.custom_fields.client2);\n            value = client.custom_value2;\n        }\n    } else if (field == 'contact.custom_value1') {\n        if (account.custom_fields.contact1 && contact.custom_value1) {\n            label = NINJA.getCustomLabel(account.custom_fields.contact1);\n            value = contact.custom_value1;\n        }\n    } else if (field == 'contact.custom_value2') {\n        if (account.custom_fields.contact2 && contact.custom_value2) {\n            label = NINJA.getCustomLabel(account.custom_fields.contact2);\n            value = contact.custom_value2;\n        }\n    } else if (field == 'account.company_name') {\n        value = account.name + ' ';\n    } else if (field == 'account.id_number') {\n        value = account.id_number;\n        if (invoiceLabels.id_number_orig) {\n            label = invoiceLabels.id_number;\n        }\n    } else if (field == 'account.vat_number') {\n        value = account.vat_number;\n        if (invoiceLabels.vat_number_orig) {\n            label = invoiceLabels.vat_number;\n        }\n    } else if (field == 'account.website') {\n        value = account.website;\n    } else if (field == 'account.email') {\n        value = account.work_email;\n    } else if (field == 'account.phone') {\n        value = account.work_phone;\n    } else if (field == 'account.address1') {\n        value = account.address1;\n    } else if (field == 'account.address2') {\n        value = account.address2;\n    } else if (field == 'account.city_state_postal') {\n        var cityStatePostal = '';\n        if (account.city || account.state || account.postal_code) {\n            var swap = account.country && account.country.swap_postal_code;\n            cityStatePostal = formatAddress(account.city, account.state, account.postal_code, swap);\n        }\n        value = cityStatePostal;\n    } else if (field == 'account.postal_city_state') {\n        var postalCityState = '';\n        if (account.city || account.state || account.postal_code) {\n            postalCityState = formatAddress(account.city, account.state, account.postal_code, true);\n        }\n        value = postalCityState;\n    } else if (field == 'account.country') {\n        value = account.country ? account.country.name : false;\n    } else if (field == 'account.custom_value1') {\n        if (invoice.account.custom_fields.account1 && invoice.account.custom_value1) {\n            label = invoice.account.custom_fields.account1;\n            value = invoice.account.custom_value1;\n        }\n    } else if (field == 'account.custom_value2') {\n        if (invoice.account.custom_fields.account2 && invoice.account.custom_value2) {\n            label = invoice.account.custom_fields.account2;\n            value = invoice.account.custom_value2;\n        }\n    } else if (field == 'invoice.invoice_number') {\n        if (! invoice.is_statement) {\n            label = invoice.is_quote ? invoiceLabels.quote_number : invoice.balance_amount < 0 ? invoiceLabels.credit_number : invoiceLabels.invoice_number;\n            value = invoice.invoice_number;\n        }\n    } else if (field == 'invoice.po_number') {\n        value = invoice.po_number;\n    } else if (field == 'invoice.invoice_date') {\n        label = invoice.is_statement ? invoiceLabels.statement_date : invoice.is_quote ? invoiceLabels.quote_date : invoice.balance_amount < 0 ? invoiceLabels.credit_date : invoiceLabels.invoice_date;\n        value = invoice.invoice_date;\n    } else if (field == 'invoice.due_date') {\n        label = invoice.is_quote ? invoiceLabels.valid_until : invoiceLabels.due_date;\n        if (invoice.partial_due_date) {\n            value = invoice.partial_due_date;\n        } else {\n            value = invoice.due_date;\n        }\n    } else if (field == 'invoice.custom_text_value1') {\n        if (invoice.custom_text_value1 && account.custom_fields.invoice_text1) {\n            label = NINJA.getCustomLabel(invoice.account.custom_fields.invoice_text1);\n            value = invoice.is_recurring ? processVariables(invoice.custom_text_value1) : invoice.custom_text_value1;\n        }\n    } else if (field == 'invoice.custom_text_value2') {\n        if (invoice.custom_text_value2 && account.custom_fields.invoice_text2) {\n            label = NINJA.getCustomLabel(invoice.account.custom_fields.invoice_text2);\n            value = invoice.is_recurring ? processVariables(invoice.custom_text_value2) : invoice.custom_text_value2;\n        }\n    } else if (field == 'invoice.balance_due') {\n        label = invoice.is_quote || invoice.balance_amount < 0 ? invoiceLabels.total : invoiceLabels.balance_due;\n        value = formatMoneyInvoice(invoice.total_amount, invoice);\n    } else if (field == 'invoice.partial_due') {\n        if (NINJA.parseFloat(invoice.partial)) {\n            label = invoiceLabels.partial_due;\n            value = formatMoneyInvoice(invoice.balance_amount, invoice);\n        }\n    } else if (field == 'invoice.invoice_total') {\n        if (invoice.is_statement || invoice.is_quote || invoice.balance_amount < 0) {\n            // hide field\n        } else {\n            value = formatMoneyInvoice(invoice.amount, invoice);\n        }\n    } else if (field == 'invoice.outstanding') {\n        if (invoice.is_statement || invoice.is_quote) {\n            // hide field\n        } else {\n            value = formatMoneyInvoice(client.balance, invoice);\n        }\n    } else if (field == '.blank') {\n        value = ' ';\n    }\n\n    if (value) {\n        var shortField = false;\n        var parts = field.split('.');\n        if (parts.length >= 2) {\n            var shortField = parts[1];\n        }\n        var style = snakeToCamel(shortField == 'company_name' ? 'account_name' : shortField); // backwards compatibility\n        if (twoColumn) {\n            // try to automatically determine the label\n            if (! label && label != 'Blank') {\n                if (invoiceLabels[shortField]) {\n                    label = invoiceLabels[shortField];\n                }\n            }\n            return [{text: label, style: [style + 'Label']}, {text: value, style: [style]}];\n        } else {\n            // if the label is set prepend it to the value\n            if (label) {\n                value = label + ': ' + value;\n            }\n            return {text:value, style: [style]};\n        }\n    } else {\n        return false;\n    }\n}\n\nNINJA.clientDetails = function(invoice) {\n    var account = invoice.account;\n    if (invoice.features.invoice_settings && account.invoice_fields) {\n        var fields = JSON.parse(account.invoice_fields).client_fields;\n    } else {\n        var fields = [\n            'client.client_name',\n            'client.id_number',\n            'client.vat_number',\n            'client.address1',\n            'client.address2',\n            'client.city_state_postal',\n            'client.country',\n            'client.email',\n            'client.custom_value1',\n            'client.custom_value2',\n            'contact.custom_value1',\n            'contact.custom_value2',\n        ];\n    }\n    var data = [];\n\n    for (var i=0; i < fields.length; i++) {\n        var field = fields[i];\n        var value = NINJA.renderField(invoice, field);\n        if (value) {\n            data.push(value);\n        }\n    }\n\n    return NINJA.prepareDataList(data, 'clientDetails');\n}\n\nNINJA.getPrimaryColor = function(defaultColor) {\n    return NINJA.primaryColor ? NINJA.primaryColor : defaultColor;\n}\n\nNINJA.getSecondaryColor = function(defaultColor) {\n    return NINJA.primaryColor ? NINJA.secondaryColor : defaultColor;\n}\n\n// remove blanks and add section style to all elements\nNINJA.prepareDataList = function(oldData, section) {\n    var newData = [];\n    if (! oldData.length) {\n        oldData.push({text:' '});\n    }\n    for (var i=0; i<oldData.length; i++) {\n        var item = NINJA.processItem(oldData[i], section);\n        if (item.text || item.stack) {\n            newData.push(item);\n        }\n    }\n    return newData;\n}\n\nNINJA.prepareDataTable = function(oldData, section) {\n    var newData = [];\n    for (var i=0; i<oldData.length; i++) {\n        var row = oldData[i];\n        var newRow = [];\n        for (var j=0; j<row.length; j++) {\n            var item = NINJA.processItem(row[j], section);\n            if (item.text || item.stack) {\n                newRow.push(item);\n            }\n        }\n        if (newRow.length) {\n            newData.push(newRow);\n        }\n    }\n    return newData;\n}\n\nNINJA.prepareDataPairs = function(oldData, section) {\n    var newData = [];\n    if (! oldData.length) {\n        oldData.push([{text:' '}, {text:' '}]);\n    }\n    for (var i=0; i<oldData.length; i++) {\n        var row = oldData[i];\n        var isBlank = false;\n        for (var j=0; j<row.length; j++) {\n            var item = NINJA.processItem(row[j], section);\n            if (!item.text) {\n                isBlank = true;\n            }\n            if (j == 1) {\n                NINJA.processItem(row[j], section + \"Value\");\n            }\n        }\n        if (!isBlank) {\n            newData.push(oldData[i]);\n        }\n    }\n    return newData;\n}\n\nNINJA.processItem = function(item, section) {\n    if (! item.style) {\n        item.style = [];\n    }\n\n    item.style.push(section);\n\n    // make sure numbers aren't wrapped\n    if (item.text && item.length && item.length < 20 && item.text.match && item.text.match(/\\d[.,]\\d\\d($| [A-Z]{3}$)/)) {\n        item.style.push('noWrap');\n    }\n\n    return item;\n}\n\n\nNINJA.parseMarkdownText = function(val, groupText)\n{\n    var rules = [\n        ['\\\\\\*\\\\\\*(\\\\\\w.+?)\\\\\\*\\\\\\*', {'bold': true}], // **value**\n        ['\\\\\\*(\\\\\\w.+?)\\\\\\*', {'italics': true}], // *value*\n        ['^###(.*)', {'style': 'help'}], // ### Small/gray help\n        ['^##(.*)', {'style': 'subheader'}], // ## Header\n        ['^#(.*)', {'style': 'fullheader'}] // # Subheader\n    ];\n\n    var parts = typeof val === 'string' ? [val] : val;\n    for (var i=0; i<rules.length; i++) {\n        var rule = rules[i];\n        var formatter = function(data) {\n            return $.extend(data, rule[1]);\n        }\n        parts = NINJA.parseRegExp(parts, rule[0], formatter, true);\n    }\n\n    return parts.length > 1 ? parts : val;\n}\n\n/*\nNINJA.parseMarkdownStack = function(val)\n{\n    if (val.length == 1) {\n        var item = val[0];\n        var line = item.hasOwnProperty('text') ? item.text : item;\n\n        if (typeof line === 'string') {\n            line = [line];\n        }\n\n        var regExp = '^\\\\\\* (.*[\\r\\n|\\n|\\r]?)';\n        var formatter = function(data) {\n            return {\"ul\": [data.text]};\n        }\n\n        val = NINJA.parseRegExp(line, regExp, formatter, false);\n    }\n\n    return val;\n}\n*/\n\nNINJA.parseRegExp = function(val, regExpStr, formatter, groupText)\n{\n    var regExp = new RegExp(regExpStr, 'gm');\n    var parts = [];\n\n    for (var i=0; i<val.length; i++) {\n        var line = val[i];\n        parts = parts.concat(NINJA.parseRegExpLine(line, regExp, formatter, groupText));\n    }\n\n    return parts.length > 1 ? parts : val;\n}\n\nNINJA.parseRegExpLine = function(line, regExp, formatter, groupText)\n{\n    var parts = [];\n    var lastIndex = -1;\n\n    while (match = regExp.exec(line)) {\n        if (match.index > lastIndex) {\n            parts.push(line.substring(lastIndex, match.index));\n        }\n        var data = {};\n        data.text = match[1];\n        data = formatter(data);\n        parts.push(data);\n        lastIndex = match.index + match[0].length;\n    }\n\n    if (parts.length) {\n        if (lastIndex < line.length) {\n            parts.push(line.substring(lastIndex));\n        }\n        return parts;\n    }\n\n    return line;\n}\n\nNINJA.getCustomLabel = function(value) {\n    if (value && value.indexOf('|') > 0) {\n        return value.split('|')[0];\n    } else {\n        return value;\n    }\n}\n"]}